<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spec Kit 项目管理面板</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="alternate icon" href="favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            padding: 0;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 20px 20px 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            color: #1e293b;
            padding: 24px 32px;
            margin: 0 -20px 24px -20px;
            animation: fadeInDown 0.6s ease-out;
            gap: 20px;
            flex-wrap: wrap;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-bottom: 1px solid #e2e8f0;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header-left {
            flex: 1;
            min-width: 300px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header h1 {
            font-size: 1.75rem;
            margin-bottom: 4px;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: #0f172a;
        }

        .header p {
            font-size: 0.875rem;
            color: #64748b;
        }

        /* 标签页导航 */
        .tabs-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            background: white;
            padding: 16px;
            border-radius: 8px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .tab-btn {
            padding: 8px 16px;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .tab-btn:hover {
            background: #e2e8f0;
            color: #334155;
            border-color: #cbd5e1;
        }

        .tab-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
        }

        .tab-btn.overview-btn {
            background: #10b981;
            color: white;
            border-color: #10b981;
        }

        .tab-btn.overview-btn:hover {
            background: #059669;
            border-color: #059669;
        }

        .tab-btn.overview-btn.active {
            background: #10b981;
            color: white;
            border-color: #10b981;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);
        }

        .add-project-btn {
            padding: 8px 20px;
            background: #3b82f6;
            color: white;
            border: 1px solid #3b82f6;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.3);
        }

        .add-project-btn:hover {
            background: #2563eb;
            border-color: #2563eb;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.4);
        }

        .add-project-btn:active {
            transform: scale(0.98);
        }

        /* 标签页内容 */
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .tab-content.active {
            display: block;
        }

        /* 项目概览页面 */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
            gap: 20px;
        }

        .project-overview-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s ease;
            border: 1px solid #e2e8f0;
            position: relative;
            overflow: hidden;
        }

        .project-overview-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: #3b82f6;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .project-overview-card:hover::before {
            opacity: 1;
        }

        .project-overview-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-color: #cbd5e1;
        }

        .project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .project-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .delete-project-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .delete-project-btn:hover {
            background: #b91c1c;
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
        }

        .delete-project-btn:active {
            transform: scale(0.98);
        }

        .iterations-summary {
            background: #f8fafc;
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
        }

        .iterations-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 8px;
        }

        .iteration-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.75rem;
        }

        .iteration-item:last-child {
            border-bottom: none;
        }

        .iteration-name {
            color: #2d3748;
            font-weight: 500;
        }

        .iteration-progress {
            color: #718096;
        }

        /* 项目内容区域 */
        .project-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 16px;
            align-items: start;
        }

        /* 迭代侧边栏 */
        .iterations-sidebar {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .add-iteration-btn {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
        }

        .add-iteration-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
        }

        .add-iteration-btn:active {
            transform: translateY(0);
        }

        .iteration-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .iteration-card {
            background: #ffffff;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .iteration-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: #2563eb;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .iteration-card:hover::before {
            opacity: 1;
        }

        .iteration-card:hover {
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transform: translateX(2px);
        }

        .iteration-card.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-color: #2563eb;
            box-shadow: 0 6px 16px rgba(37, 99, 235, 0.4);
        }

        .iteration-card.active::before {
            opacity: 0;
        }

        .iteration-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .iteration-card-name {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .iteration-card.active .iteration-card-name {
            color: white;
        }

        .delete-iteration-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .delete-iteration-btn:hover {
            background: #b91c1c;
            transform: scale(1.05);
        }

        .delete-iteration-btn:active {
            transform: scale(0.95);
        }

        .iteration-card.active .delete-iteration-btn {
            background: rgba(255, 255, 255, 0.25);
        }

        .iteration-card.active .delete-iteration-btn:hover {
            background: rgba(255, 255, 255, 0.35);
        }

        .iteration-card-desc {
            font-size: 0.7rem;
            color: #718096;
            margin-bottom: 6px;
            line-height: 1.3;
        }

        .iteration-card.active .iteration-card-desc {
            color: rgba(255,255,255,0.9);
        }

        .iteration-card-progress {
            font-size: 0.7rem;
            color: #4a5568;
        }

        .iteration-card.active .iteration-card-progress {
            color: rgba(255,255,255,0.95);
        }

        /* 工作流程区域 */
        .workflow-area {
            background: white;
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .workflow-area::-webkit-scrollbar,
        .iterations-sidebar::-webkit-scrollbar {
            width: 8px;
        }

        .workflow-area::-webkit-scrollbar-track,
        .iterations-sidebar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .workflow-area::-webkit-scrollbar-thumb,
        .iterations-sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e0;
            border-radius: 4px;
        }

        .workflow-area::-webkit-scrollbar-thumb:hover,
        .iterations-sidebar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .workflow {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-bottom: 12px;
        }

        .command-card {
            background: white;
            border-radius: 10px;
            padding: 18px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            border: 2px solid #e5e7eb;
        }

        .command-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #cbd5e0;
        }

        .command-card.completed {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
        }

        .command-card.completed.init-phase {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #9ca3af;
            opacity: 0.85;
        }

        .command-card.completed.cycle-1 {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
        }

        .command-card.completed.cycle-2 {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%);
            border: 2px solid #ec4899;
        }

        .command-card.completed.cycle-3 {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
        }

        .command-card.completed.cycle-4 {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            border: 2px solid #6366f1;
        }

        .command-card.completed.cycle-5 {
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 100%);
            border: 2px solid #14b8a6;
        }

        .command-card.completed.cycle-6 {
            background: linear-gradient(135deg, #ffe4e6 0%, #fecdd3 100%);
            border: 2px solid #f43f5e;
        }

        .command-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #2563eb, #1d4ed8);
            border-radius: 10px 10px 0 0;
        }

        .command-card.completed::before {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        .command-card.completed.init-phase::before {
            background: linear-gradient(90deg, #9ca3af, #6b7280);
        }

        .command-card.completed.cycle-1::before {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .command-card.completed.cycle-2::before {
            background: linear-gradient(90deg, #ec4899, #db2777);
        }

        .command-card.completed.cycle-3::before {
            background: linear-gradient(90deg, #f59e0b, #d97706);
        }

        .command-card.completed.cycle-4::before {
            background: linear-gradient(90deg, #6366f1, #4f46e5);
        }

        .command-card.completed.cycle-5::before {
            background: linear-gradient(90deg, #14b8a6, #0d9488);
        }

        .command-card.completed.cycle-6::before {
            background: linear-gradient(90deg, #f43f5e, #e11d48);
        }

        .step-number {
            display: inline-block;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
        }

        .command-card.completed .step-number {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .command-card.completed.init-phase .step-number {
            background: linear-gradient(135deg, #9ca3af, #6b7280);
        }

        .command-card.completed.cycle-1 .step-number {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }

        .command-card.completed.cycle-2 .step-number {
            background: linear-gradient(135deg, #ec4899, #db2777);
        }

        .command-card.completed.cycle-3 .step-number {
            background: linear-gradient(135deg, #f59e0b, #d97706);
        }

        .command-card.completed.cycle-4 .step-number {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
        }

        .command-card.completed.cycle-5 .step-number {
            background: linear-gradient(135deg, #14b8a6, #0d9488);
        }

        .command-card.completed.cycle-6 .step-number {
            background: linear-gradient(135deg, #f43f5e, #e11d48);
        }

        .command-title {
            font-size: 1.05rem;
            font-weight: 700;
            margin-bottom: 6px;
            color: #1e293b;
            letter-spacing: -0.2px;
        }

        .command-subtitle {
            font-size: 0.8rem;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 500;
            font-style: italic;
        }

        .command-desc {
            font-size: 0.85rem;
            color: #475569;
            line-height: 1.6;
            margin-bottom: 12px;
        }

        .command-box {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px dashed #cbd5e0;
            border-radius: 6px;
            padding: 10px;
            font-family: 'SF Mono', 'Monaco', 'Courier New', monospace;
            font-size: 0.78rem;
            color: #1e293b;
            margin-bottom: 10px;
            word-break: break-all;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            font-weight: 500;
        }

        /* T040: Dynamic input fields (single-line & multi-line support) */
        .command-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.8rem;
            color: #2d3748;
            margin-bottom: 10px;
            font-family: inherit;
            line-height: 1.4;
            transition: all 0.2s;
            background: #f8fafc;
            resize: none;
            overflow-y: hidden;
            min-height: 38px;
            max-height: 120px; /* T041: ~5 lines with scrollbar */
        }

        .command-input:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .command-input::placeholder {
            color: #94a3b8;
        }

        /* T042: Code snippet styling (monospace font) */
        .command-input.code-style {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.75rem;
            background: #1e293b;
            color: #e2e8f0;
            border-color: #475569;
        }

        .command-input.code-style:focus {
            border-color: #64748b;
            background: #0f172a;
            box-shadow: 0 0 0 3px rgba(71, 85, 105, 0.2);
        }

        .command-input.code-style::placeholder {
            color: #64748b;
        }

        .command-notes {
            width: 100%;
            padding: 10px;
            border: 2px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #2d3748;
            margin-bottom: 10px;
            font-family: inherit;
            resize: vertical;
            min-height: 70px;
            transition: all 0.2s;
            background: #f8fafc;
        }

        .command-notes:focus {
            outline: none;
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .command-notes::placeholder {
            color: #94a3b8;
        }

        .copy-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            position: relative;
            overflow: hidden;
        }

        .copy-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .copy-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .copy-btn:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
        }

        .copy-btn:active {
            transform: scale(0.98) translateY(0);
        }

        .copy-btn.copied {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.4);
        }

        .note {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-left: 4px solid #f59e0b;
            padding: 10px 12px;
            margin-top: 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            color: #92400e;
            line-height: 1.5;
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.15);
        }

        .phase-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 10px;
            padding: 16px 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        .phase-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #2563eb, #3b82f6);
        }

        .phase-header h2 {
            color: #1e293b;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            margin-left: 4px;
        }

        .phase-icon {
            font-size: 1.3rem;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        /* 模态框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(2px);
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            max-width: 520px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(0,0,0,0.1);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 24px;
            color: #1e293b;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: #4a5568;
            margin-bottom: 6px;
            font-weight: 600;
        }

        .form-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            font-size: 0.95rem;
            min-height: 100px;
            resize: vertical;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-textarea:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
        }

        .modal-btn-primary:hover {
            background: linear-gradient(135deg, #1d4ed8, #1e40af);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.4);
        }

        .modal-btn-primary:active {
            transform: translateY(0);
        }

        .modal-btn-secondary {
            background: #e2e8f0;
            color: #475569;
            border: 2px solid #cbd5e0;
        }

        .modal-btn-secondary:hover {
            background: #cbd5e0;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        .modal-btn-secondary:active {
            transform: translateY(0);
        }

        @media (max-width: 1200px) {
            .project-content {
                grid-template-columns: 1fr;
            }

            .iterations-sidebar {
                max-height: 250px;
                position: relative;
                top: 0;
            }

            .workflow-area {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 15px;
            }

            .header h1 {
                font-size: 1.6rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .tabs-nav {
                padding: 10px;
                gap: 8px;
            }

            .tab-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .add-project-btn {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .workflow {
                grid-template-columns: 1fr;
            }

            .overview-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 24px;
                width: 95%;
            }

            .modal-title {
                font-size: 1.3rem;
            }

            .cycle-selector {
                padding: 16px;
            }

            .cycle-options {
                gap: 8px;
            }

            .cycle-option {
                padding: 6px 12px;
                font-size: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.4rem;
            }

            .project-name {
                font-size: 1rem;
            }

            .command-card {
                padding: 14px;
            }

            .phase-header {
                padding: 12px 16px;
            }

            .phase-header h2 {
                font-size: 1rem;
            }
        }

        .completed-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #10b981;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
        }

        .command-card.completed.init-phase .completed-badge {
            background: #9ca3af;
        }

        .command-card.completed.cycle-1 .completed-badge {
            background: #3b82f6;
        }

        .command-card.completed.cycle-2 .completed-badge {
            background: #ec4899;
        }

        .command-card.completed.cycle-3 .completed-badge {
            background: #f59e0b;
        }

        .command-card.completed.cycle-4 .completed-badge {
            background: #6366f1;
        }

        .command-card.completed.cycle-5 .completed-badge {
            background: #14b8a6;
        }

        .command-card.completed.cycle-6 .completed-badge {
            background: #f43f5e;
        }

        /* 循环选择器 */
        .cycle-selector {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            border: 2px solid #e5e7eb;
            position: relative;
            overflow: hidden;
        }

        .cycle-selector::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #2563eb, #ec4899, #f59e0b, #10b981);
        }

        .cycle-selector-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cycle-selector-title::before {
            content: '🎨';
            font-size: 1.2rem;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .cycle-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .cycle-option {
            padding: 8px 16px;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cycle-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .cycle-option.init {
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
            color: #6b7280;
            border-color: #9ca3af;
        }

        .cycle-option.cycle-1 {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            color: #1e40af;
            border-color: #3b82f6;
        }

        .cycle-option.cycle-2 {
            background: linear-gradient(135deg, #fce7f3, #fbcfe8);
            color: #be185d;
            border-color: #ec4899;
        }

        .cycle-option.cycle-3 {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            color: #92400e;
            border-color: #f59e0b;
        }

        .cycle-option.cycle-4 {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            color: #3730a3;
            border-color: #6366f1;
        }

        .cycle-option.cycle-5 {
            background: linear-gradient(135deg, #ccfbf1, #99f6e4);
            color: #115e59;
            border-color: #14b8a6;
        }

        .cycle-option.cycle-6 {
            background: linear-gradient(135deg, #ffe4e6, #fecdd3);
            color: #9f1239;
            border-color: #f43f5e;
        }

        .cycle-option.active {
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            transform: scale(1.08) translateY(-2px);
            border-width: 3px;
            animation: pulseGlow 2s ease-in-out infinite;
        }

        @keyframes pulseGlow {
            0%, 100% {
                box-shadow: 0 6px 20px rgba(0,0,0,0.25);
            }
            50% {
                box-shadow: 0 6px 24px rgba(0,0,0,0.35);
            }
        }

        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #718096;
            animation: fadeIn 0.6s ease-out;
        }

        .empty-state-icon {
            font-size: 5rem;
            margin-bottom: 24px;
            opacity: 0.7;
            filter: drop-shadow(0 2px 8px rgba(0,0,0,0.1));
            animation: floatAnimation 3s ease-in-out infinite;
        }

        @keyframes floatAnimation {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        .empty-state-text {
            font-size: 1.05rem;
            line-height: 1.8;
        }

        /* 数据管理按钮 */
        .data-btn {
            padding: 8px 16px;
            background: #f1f5f9;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .data-btn:hover {
            background: #e2e8f0;
            color: #334155;
            border-color: #cbd5e1;
        }

        .export-btn {
            color: #059669;
            border-color: #a7f3d0;
            background: #d1fae5;
        }

        .export-btn:hover {
            background: #a7f3d0;
            border-color: #6ee7b7;
        }

        .import-btn {
            color: #2563eb;
            border-color: #bfdbfe;
            background: #dbeafe;
        }

        .import-btn:hover {
            background: #bfdbfe;
            border-color: #93c5fd;
        }

        .clear-btn {
            color: #dc2626;
            border-color: #fecaca;
            background: #fee2e2;
        }

        .clear-btn:hover {
            background: #fecaca;
            border-color: #fca5a5;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            top: 80px;
            right: 24px;
            background: white;
            padding: 8px 14px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10000;
            display: none;
            align-items: center;
            gap: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            border-left: 3px solid #10b981;
            animation: toastSlideIn 0.3s ease-out;
            max-width: 280px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translateX(100px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .toast.show {
            display: flex;
        }

        .toast.success {
            border-left-color: #10b981;
            color: #059669;
        }

        .toast.error {
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .toast.warning {
            border-left-color: #f59e0b;
            color: #d97706;
        }

        /* T045: Loading Spinner & Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(2px);
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spinner-rotate 0.8s linear infinite;
        }

        @keyframes spinner-rotate {
            to {
                transform: rotate(360deg);
            }
        }

        .loading-text {
            color: white;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 20px;
            text-align: center;
        }

        /* 左侧项目树布局 */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            align-items: start;
        }

        .project-tree-sidebar {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 20px;
        }

        .project-tree-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
        }

        .project-tree-title {
            font-size: 1rem;
            font-weight: 700;
            color: #1e293b;
        }

        .project-tree-item {
            margin-bottom: 8px;
        }

        .project-tree-node {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
            border: 2px solid transparent;
        }

        .project-tree-node:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
        }

        .project-tree-node.active {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            color: white;
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .expand-icon {
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .project-tree-label {
            flex: 1;
            font-size: 0.85rem;
            font-weight: 600;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* T022: Project action buttons CSS */
        .project-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .project-tree-node:hover .project-actions {
            opacity: 1;
        }

        .project-action-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 28px;
        }

        .project-action-btn:hover {
            background: white;
            border-color: #2563eb;
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.2);
        }

        .project-action-btn.project-action-delete:hover {
            border-color: #ef4444;
            background: #fef2f2;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.2);
        }

        .project-tree-node.active .project-action-btn {
            background: rgba(255, 255, 255, 0.95);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .project-tree-node.active .project-action-btn:hover {
            background: white;
            border-color: white;
        }

        .project-tree-children {
            margin-left: 24px;
            margin-top: 4px;
            display: none;
        }

        .project-tree-children.expanded {
            display: block;
        }

        /* T035-T038: Progress Dashboard Styles */
        .project-tree-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 0;
        }

        .progress-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .progress-metrics {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .iteration-count {
            color: #64748b;
            font-size: 0.7rem;
        }

        .completion-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .completion-badge.empty {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .completion-badge.in-progress {
            background: #dbeafe;
            color: #2563eb;
        }

        .completion-badge.complete {
            background: #d1fae5;
            color: #059669;
        }

        /* T036: Progress bar styles */
        .progress-bar {
            width: 100%;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar-fill {
            height: 100%;
            transition: width 0.3s ease, background 0.3s ease;
            border-radius: 2px;
        }

        .progress-bar-fill.empty {
            width: 0;
            background: #cbd5e1;
        }

        .progress-bar-fill.in-progress {
            background: linear-gradient(90deg, #3b82f6, #2563eb);
        }

        .progress-bar-fill.complete {
            background: linear-gradient(90deg, #10b981, #059669);
        }

        /* T037: Last updated styles */
        .last-updated {
            color: #94a3b8;
            font-size: 0.65rem;
            font-style: italic;
        }

        /* Active state overrides */
        .project-tree-node.active .progress-info {
            opacity: 1;
        }

        .project-tree-node.active .iteration-count,
        .project-tree-node.active .last-updated {
            color: rgba(255, 255, 255, 0.8);
        }

        .project-tree-node.active .completion-badge {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .project-tree-node.active .progress-bar {
            background: rgba(255, 255, 255, 0.3);
        }

        .project-tree-node.active .progress-bar-fill {
            background: white;
        }

        .iteration-tree-node {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            border: 2px solid #e5e7eb;
            margin-bottom: 4px;
            font-size: 0.8rem;
        }

        .iteration-tree-node:hover {
            border-color: #cbd5e0;
            background: #f8fafc;
        }

        .iteration-tree-node.active {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border-color: #10b981;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .iteration-tree-label {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .iteration-tree-badge {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e5e7eb;
            color: #64748b;
            font-weight: 600;
        }

        .iteration-tree-node.active .iteration-tree-badge {
            background: rgba(255,255,255,0.25);
            color: white;
        }

        /* ========================================
           Step Indicators & Progress (Phase 5)
           ======================================== */

        .iteration-tree-node {
            flex-direction: column;
            align-items: flex-start;
            gap: 8px;
        }

        .iteration-tree-progress {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .iteration-progress-bar {
            flex: 1;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);
        }

        .iteration-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 4px rgba(16, 185, 129, 0.4);
        }

        .iteration-tree-node.active .iteration-progress-bar {
            background: rgba(255,255,255,0.3);
        }

        .iteration-tree-node.active .iteration-progress-fill {
            background: white;
            box-shadow: 0 0 6px rgba(255,255,255,0.6);
        }

        .step-indicators-container {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            align-items: center;
            width: 100%;
            padding-top: 4px;
        }

        .step-indicator {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            transition: all 0.2s ease;
            position: relative;
        }

        .step-indicator.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 1px 3px rgba(16, 185, 129, 0.3);
        }

        .step-indicator.incomplete {
            background: #e5e7eb;
            color: #94a3b8;
            border: 2px solid #cbd5e0;
        }

        .iteration-tree-node.active .step-indicator.completed {
            background: white;
            color: #10b981;
            box-shadow: 0 2px 4px rgba(0,0,0,0.15);
        }

        .iteration-tree-node.active .step-indicator.incomplete {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.4);
            color: rgba(255,255,255,0.7);
        }

        .step-indicator:hover {
            transform: scale(1.15);
            z-index: 10;
        }

        .step-indicator.completed:hover {
            box-shadow: 0 2px 6px rgba(16, 185, 129, 0.5);
        }

        /* Furthest iteration highlight (T032) */
        .iteration-tree-node.furthest {
            border-color: #f59e0b;
            box-shadow: 0 2px 12px rgba(245, 158, 11, 0.2);
        }

        .iteration-tree-node.furthest::before {
            content: '🏆';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 12px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
        }

        .iteration-tree-node.furthest:not(.active) {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
        }

        .iteration-tree-node.furthest:not(.active):hover {
            background: linear-gradient(135deg, #fde68a, #fcd34d);
        }

        /* Tooltip styling (T033) */
        .step-indicator[data-tooltip]:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 120%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            white-space: pre-line;
            max-width: 250px;
            min-width: 180px;
            text-align: left;
            z-index: 1000;
            pointer-events: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: tooltipFadeIn 0.2s ease-out;
        }

        .step-indicator[data-tooltip]:hover::before {
            content: '';
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            border: 5px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            pointer-events: none;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(5px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .main-content-area {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            min-height: calc(100vh - 200px);
        }

        @media (max-width: 1024px) {
            .main-layout {
                grid-template-columns: 1fr;
            }

            .project-tree-sidebar {
                position: relative;
                top: 0;
                max-height: 300px;
            }
        }

        /* ========================================
           Authentication UI Styles (认证界面样式)
           ======================================== */

        #authOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        }

        #authOverlay.hidden {
            display: none;
        }

        .auth-container {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 440px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #1e3a8a;
            font-size: 1.8rem;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .auth-header p {
            color: #6b7280;
            font-size: 0.95rem;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            background: #f3f4f6;
            padding: 6px;
            border-radius: 10px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-tab.active {
            background: white;
            color: #2563eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #374151;
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
            font-family: inherit;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group input::placeholder {
            color: #9ca3af;
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 10px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .auth-error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            margin-bottom: 20px;
            display: none;
        }

        .auth-error.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .auth-footer {
            margin-top: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 0.85rem;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.85rem;
            font-weight: 600;
            z-index: 9999;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: fadeIn 0.3s;
        }

        .connection-status.online {
            color: #059669;
        }

        .connection-status.offline {
            color: #dc2626;
        }

        .user-info {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.85rem;
            z-index: 9999;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .user-info.show {
            display: flex;
        }

        .user-email {
            color: #374151;
            font-weight: 600;
        }

        .logout-btn {
            padding: 6px 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        /* Connection Status & Inline User Info */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.875rem;
            color: #475569;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .status-dot.offline {
            background: #ef4444;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .status-text {
            font-weight: 500;
        }

        .user-info-inline {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 8px 14px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 20px;
            font-size: 0.875rem;
        }

        .user-info-inline.show {
            display: flex;
        }

        .user-email-inline {
            color: #334155;
            font-weight: 500;
        }

        .logout-btn-inline {
            padding: 6px 12px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .logout-btn-inline:hover {
            background: #b91c1c;
            transform: translateY(-1px);
        }

        /* Hide old floating user info */
        .user-info {
            display: none !important;
        }

        /* ============================================ */
        /* T057-T061: Command Library Styles */
        /* ============================================ */

        /* View tabs navigation */
        .view-tabs {
            display: flex;
            gap: 8px;
            padding: 0;
            background: white;
            border-bottom: 1px solid #e2e8f0;
            margin: 0 -20px 24px -20px;
            padding: 0 32px;
        }

        .view-tab-btn {
            padding: 16px 24px;
            border: none;
            background: transparent;
            border-bottom: 2px solid transparent;
            border-radius: 0;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-tab-btn:hover {
            color: #3b82f6;
            background: #f8fafc;
        }

        .view-tab-btn.active {
            background: transparent;
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            font-weight: 600;
        }

        /* Tab content containers */
        .tab-content {
            flex: 1;
            overflow: auto;
        }

        /* T057: Commands header styles */
        .commands-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: white;
            border-bottom: 2px solid #e5e7eb;
        }

        .search-container {
            flex: 1;
        }

        .command-search-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .command-search-input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .add-command-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-command-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Command list container */
        .command-list {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
            overflow-y: auto; /* T011: Ensure smooth scrolling */
            will-change: transform; /* T012: GPU-accelerated scrolling for performance */
            /* T005: Smooth transition for grid template changes */
            transition: grid-template-columns 0.3s ease, gap 0.3s ease;
            /* T043 [US3]: Overflow prevention for multi-column layout */
            overflow-x: hidden;
            box-sizing: border-box;
        }

        /* T058: Command category styles */
        /* T024-T025: Category color styling support */
        .command-category {
            margin-bottom: 32px;
            border-left: 4px solid transparent; /* Color set via inline style */
            padding-left: 12px;
            transition: border-color 0.2s;
            /* T045 [US3]: Overflow prevention */
            box-sizing: border-box;
            max-width: 100%;
        }

        .command-category-header {
            font-size: 1.1rem;
            font-weight: 700;
            padding: 8px 12px;
            margin-bottom: 16px;
            border-radius: 6px;
            /* Background and color will be set inline via JavaScript */
        }

        /* T059: Command item styles */
        .command-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            margin-bottom: 12px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: grab;
            transition: all 0.2s;
            /* T044 [US3]: Overflow prevention */
            box-sizing: border-box;
            max-width: 100%;
            overflow: hidden;
        }

        .command-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .command-item:active {
            cursor: grabbing;
        }

        /* T060: Command info and actions layout */
        .command-info {
            flex: 1;
            min-width: 0;
            margin-right: 16px;
        }

        .command-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 6px;
            /* T004: Text overflow handling for multi-column layout */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
            /* T006: Smooth font size transitions */
            transition: font-size 0.3s ease, line-height 0.3s ease;
        }

        .command-text {
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            color: #64748b;
            background: #f8fafc;
            padding: 8px 12px;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            /* T004: Ensure min-width for grid children */
            min-width: 0;
            /* T006: Smooth font size transitions */
            transition: font-size 0.3s ease, line-height 0.3s ease;
        }

        .command-actions {
            display: flex;
            gap: 8px;
        }

        .command-action-btn {
            padding: 8px 12px;
            background: white;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .command-action-btn:hover {
            transform: scale(1.1);
        }

        /* T002: Density Optimization Classes (Feature 006) */
        /* These classes optimize layout for 30% more content per viewport */

        .command-item-dense {
            padding: 12px !important;
            margin-bottom: 10px !important;
        }

        .command-label-dense {
            font-size: 0.9rem !important;
            margin-bottom: 4px !important;
        }

        .command-text-dense {
            font-size: 0.8rem !important;
            line-height: 1.3 !important;
        }

        .command-action-btn.copy-btn:hover {
            background: #dbeafe;
            border-color: #2563eb;
        }

        .command-action-btn.edit-btn:hover {
            background: #fef3c7;
            border-color: #f59e0b;
        }

        .command-action-btn.delete-btn:hover {
            background: #fef2f2;
            border-color: #ef4444;
        }

        /* T007-T013: Column Selector UI Styles (Feature 007-1-20-20) */
        .column-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .column-selector label {
            font-weight: 600;
            font-size: 0.9rem;
            color: #475569;
        }

        .column-selector input[type="range"] {
            flex: 1;
            max-width: 300px;
        }

        .column-selector-display {
            font-weight: 700;
            font-size: 1.1rem;
            color: #2563eb;
            min-width: 2rem;
            text-align: center;
        }

        .column-preset-btn {
            padding: 0.4rem 0.8rem;
            font-size: 0.85rem;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .column-preset-btn:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .column-preset-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        /* T061: Toast notification type styles */
        .toast-success {
            border-left-color: #10b981;
            color: #059669;
        }

        .toast-error {
            border-left-color: #ef4444;
            color: #dc2626;
        }

        .toast-info {
            border-left-color: #2563eb;
            color: #1d4ed8;
        }

        /* Custom Confirm Dialog */
        .confirm-dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10001;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }

        .confirm-dialog-overlay.show {
            display: flex;
        }

        .confirm-dialog {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            width: 90%;
            padding: 20px 24px;
            animation: confirmSlideIn 0.2s ease-out;
        }

        @keyframes confirmSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .confirm-dialog-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .confirm-dialog-message {
            font-size: 0.875rem;
            color: #475569;
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .confirm-dialog-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .confirm-dialog-btn {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }

        .confirm-dialog-btn-cancel {
            background: #f1f5f9;
            color: #475569;
            border-color: #e2e8f0;
        }

        .confirm-dialog-btn-cancel:hover {
            background: #e2e8f0;
            border-color: #cbd5e1;
        }

        .confirm-dialog-btn-confirm {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .confirm-dialog-btn-confirm:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        .confirm-dialog-btn-confirm.danger {
            background: #dc2626;
            border-color: #dc2626;
        }

        .confirm-dialog-btn-confirm.danger:hover {
            background: #b91c1c;
            border-color: #b91c1c;
        }
    </style>

    <!-- Firebase SDK v12.4.0 (Modular ES Modules via CDN) -->
    <script type="module">
        // Import Firebase core and services
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js';
        import {
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence
        } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js';
        import {
            getDatabase,
            ref,
            set,
            get,
            update,
            remove,
            onValue,
            push,
            child,
            serverTimestamp
        } from 'https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js';

        // Make Firebase available globally
        window.firebase = {
            app: null,
            auth: null,
            db: null,
            initializeApp,
            getAuth,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            setPersistence,
            browserLocalPersistence,
            getDatabase,
            ref,
            set,
            get,
            update,
            remove,
            onValue,
            push,
            child,
            serverTimestamp
        };

        console.log('✅ Firebase SDK v12.4.0 loaded successfully');
    </script>
</head>
<body>
    <!-- Authentication Overlay (认证覆盖层) -->
    <div id="authOverlay" class="hidden">
        <div class="auth-container">
            <div class="auth-header">
                <h2>🚀 Spec Kit 项目管理</h2>
                <p>请登录或注册以继续</p>
            </div>

            <!-- Tab Navigation (标签导航) -->
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">登录</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">注册</button>
            </div>

            <!-- Error Message (错误消息) -->
            <div id="authError" class="auth-error"></div>

            <!-- Login Form (登录表单) -->
            <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">邮箱地址</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="loginPassword">密码</label>
                    <input type="password" id="loginPassword" placeholder="••••••••" required autocomplete="current-password" minlength="6">
                </div>
                <button type="submit" class="auth-button" id="loginButton">
                    登录
                </button>
            </form>

            <!-- Register Form (注册表单) -->
            <form id="registerForm" class="auth-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label for="registerEmail">邮箱地址</label>
                    <input type="email" id="registerEmail" placeholder="your@email.com" required autocomplete="email">
                </div>
                <div class="form-group">
                    <label for="registerPassword">密码</label>
                    <input type="password" id="registerPassword" placeholder="至少 6 位字符" required autocomplete="new-password" minlength="6">
                </div>
                <div class="form-group">
                    <label for="registerPasswordConfirm">确认密码</label>
                    <input type="password" id="registerPasswordConfirm" placeholder="再次输入密码" required autocomplete="new-password" minlength="6">
                </div>
                <button type="submit" class="auth-button" id="registerButton">
                    注册
                </button>
            </form>

            <!-- Footer (页脚) -->
            <div class="auth-footer">
                <p>使用 Firebase Authentication 保护您的数据安全</p>
            </div>
        </div>
    </div>

    <!--
        Old floating connection status and user info removed - now using inline versions in header
        旧的浮动连接状态和用户信息已移除 - 现在使用页眉中的内嵌版本
    -->

    <div class="container" id="mainApp">
        <div class="header">
            <div class="header-left">
                <h1>🚀 Spec Kit 项目管理面板</h1>
                <p>规范驱动开发（SDD）完整工作流</p>
            </div>
            <div class="header-right">
                <button class="add-project-btn" onclick="openAddProjectModal()">➕ 新建项目</button>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot"></span>
                    <span class="status-text">连接中...</span>
                </div>
                <div class="user-info-inline" id="userInfoInline">
                    <span class="user-email-inline" id="userEmailInline"></span>
                    <button class="logout-btn-inline" onclick="handleLogout()">登出</button>
                </div>
            </div>
        </div>

        <!-- T051: Tab Navigation -->
        <div class="view-tabs">
            <button class="view-tab-btn active" onclick="switchTab('projects')">📁 项目管理</button>
            <button class="view-tab-btn" onclick="switchTab('commands')">📋 命令库</button>
        </div>

        <!-- 工具栏 -->
        <div class="tabs-nav" id="tabsNav">
            <button class="data-btn export-btn" onclick="exportAllProjects()">💾 导出数据</button>
            <button class="data-btn import-btn" onclick="openImportModal()">📂 导入数据</button>
            <button class="data-btn clear-btn" onclick="openClearDataModal()">🗑️ 清空数据</button>
        </div>

        <!-- T052-T053: Command Library Tab (initially hidden) -->
        <div id="commands-tab" class="tab-content" style="display: none;">
            <div class="commands-header">
                <div class="search-container">
                    <input type="text"
                           id="commandSearchInput"
                           class="command-search-input"
                           placeholder="🔍 搜索命令（标签、文本或分类）..."
                           oninput="handleSearchCommands(this.value)">
                </div>
                <button class="add-command-btn" onclick="handleAddCommand()">➕ 添加命令</button>
            </div>
            <div id="command-list" class="command-list"></div>
        </div>

        <!-- Projects Tab (main layout) -->
        <div id="projects-tab" class="tab-content" style="display: block;">
            <!-- 主布局：左侧项目树 + 右侧内容区 -->
            <div class="main-layout" id="mainLayout">
            <!-- 左侧项目树 -->
            <div class="project-tree-sidebar" id="projectTree"></div>

            <!-- 右侧主内容区 -->
            <div class="main-content-area" id="mainContent"></div>
            </div> <!-- end main-layout -->
        </div> <!-- end projects-tab -->

        <!-- 新建项目模态框 -->
        <div class="modal" id="addProjectModal">
            <div class="modal-content">
                <div class="modal-title">新建项目</div>
                <div class="form-group">
                    <label class="form-label">项目名称</label>
                    <input type="text" class="form-input" id="newProjectName" placeholder="输入项目名称">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" onclick="closeAddProjectModal()">取消</button>
                    <button class="modal-btn modal-btn-primary" onclick="addProject()">创建</button>
                </div>
            </div>
        </div>

        <!-- 新建迭代模态框 -->
        <div class="modal" id="addIterationModal">
            <div class="modal-content">
                <div class="modal-title">新建迭代</div>
                <div class="form-group">
                    <label class="form-label">迭代名称</label>
                    <input type="text" class="form-input" id="newIterationName" placeholder="例如: 增加UI、多Agent版本">
                </div>
                <div class="form-group">
                    <label class="form-label">迭代描述（可选）</label>
                    <textarea class="form-textarea" id="newIterationDesc" placeholder="描述本次迭代的目标和内容"></textarea>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" onclick="closeAddIterationModal()">取消</button>
                    <button class="modal-btn modal-btn-primary" onclick="addIteration()">创建</button>
                </div>
            </div>
        </div>

        <!-- 导入数据模态框 -->
        <div class="modal" id="importModal">
            <div class="modal-content">
                <div class="modal-title">导入项目数据</div>
                <div class="form-group">
                    <label class="form-label">选择 JSON 文件</label>
                    <input type="file" id="importFileInput" accept=".json" class="form-input" onchange="handleFileSelect(event)">
                </div>
                <div id="importPreview" style="display: none; margin-top: 16px;">
                    <div class="form-label">文件预览</div>
                    <div id="importPreviewContent" style="background: #f8fafc; padding: 12px; border-radius: 6px; font-size: 0.85rem; color: #475569; border: 2px solid #e5e7eb;"></div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label class="form-label">导入模式</label>
                        <div style="display: flex; gap: 12px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="importMode" value="merge" checked>
                                <span style="font-size: 0.9rem;">合并模式（保留现有数据）</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                <input type="radio" name="importMode" value="replace">
                                <span style="font-size: 0.9rem; color: #dc2626;">覆盖模式（清空现有数据）</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" onclick="closeImportModal()">取消</button>
                    <button class="modal-btn modal-btn-primary" id="confirmImportBtn" onclick="confirmImport()" disabled>导入</button>
                </div>
            </div>
        </div>

        <!-- 清空数据模态框 -->
        <div class="modal" id="clearDataModal">
            <div class="modal-content">
                <div class="modal-title" style="color: #dc2626;">⚠️ 清空所有数据</div>
                <div style="background: #fef2f2; padding: 16px; border-radius: 8px; border: 2px solid #fecaca; margin-bottom: 16px;">
                    <p style="color: #991b1b; font-size: 0.9rem; line-height: 1.6; margin-bottom: 12px;">
                        <strong>警告：</strong>此操作将永久删除所有项目数据，且<strong>不可撤销</strong>！
                    </p>
                    <p style="color: #991b1b; font-size: 0.85rem;">
                        建议在清空前先导出数据进行备份。
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">请输入 <strong style="color: #dc2626;">确认删除</strong> 以继续</label>
                    <input type="text" class="form-input" id="clearConfirmInput" placeholder="输入"确认删除"">
                </div>
                <div class="modal-actions">
                    <button class="modal-btn modal-btn-secondary" onclick="closeClearDataModal()">取消</button>
                    <button class="modal-btn" style="background: #dc2626; color: white;" onclick="confirmClearData()">确认清空</button>
                </div>
            </div>
        </div>

        <!-- Toast 通知 -->
        <div id="toast" class="toast"></div>

        <!-- T045: Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div>
                <div class="loading-spinner"></div>
                <div class="loading-text" id="loadingText">加载中...</div>
            </div>
        </div>

        <!-- Custom Confirm Dialog -->
        <div id="confirmDialogOverlay" class="confirm-dialog-overlay">
            <div class="confirm-dialog">
                <div class="confirm-dialog-title" id="confirmDialogTitle"></div>
                <div class="confirm-dialog-message" id="confirmDialogMessage"></div>
                <div class="confirm-dialog-actions">
                    <button class="confirm-dialog-btn confirm-dialog-btn-cancel" id="confirmDialogCancel">取消</button>
                    <button class="confirm-dialog-btn confirm-dialog-btn-confirm" id="confirmDialogConfirm">确认</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // Firebase Configuration & Initialization
        // ========================================

        // Firebase configuration (from .env file)
        // ⚠️ SECURITY: These credentials are safe for client-side web apps
        // Real security is enforced by Firebase Security Rules on the server
        const firebaseConfig = {
            apiKey: "AIzaSyBo5-m7olgLlNU_9sGA7sm78VDiIEuLfAc",
            authDomain: "speckit-project-manager.firebaseapp.com",
            databaseURL: "https://speckit-project-manager-default-rtdb.firebaseio.com",
            projectId: "speckit-project-manager",
            storageBucket: "speckit-project-manager.firebasestorage.app",
            messagingSenderId: "1053522228569",
            appId: "1:1053522228569:web:4ae98ea1c7427028c3c848"
        };

        // Global Firebase state (全局 Firebase 状态)
        let currentUser = null;          // Current authenticated user (当前认证用户)
        let isOnline = navigator.onLine; // Online/offline status (在线/离线状态)
        let firebaseInitialized = false; // Firebase initialization status (Firebase 初始化状态)
        let offlineQueue = [];           // Queue for offline operations (离线操作队列)

        // T016: Data schema version for cycle management (Feature 004-)
        const DATA_VERSION = 2; // V2: Cycle-keyed data structure

        // Expose to window for testing and cross-script access
        // 暴露到 window 对象以便测试和跨脚本访问
        window.firebaseConfig = firebaseConfig;
        window.currentUser = currentUser;
        window.isOnline = isOnline;
        window.firebaseInitialized = firebaseInitialized;
        window.offlineQueue = offlineQueue;

        // ============================================================
        // DATA ACCESS LAYER | 数据访问层
        // ============================================================
        // Handles Firebase and localStorage operations
        // Functions: initFirebase, saveProjectToFirebase, loadProjectsFromFirebase, etc.
        // 处理 Firebase 和 localStorage 操作
        // 函数：initFirebase, saveProjectToFirebase, loadProjectsFromFirebase 等

        /**
         * Initialize Firebase app and services
         * 初始化 Firebase 应用和服务
         * @returns {Promise<void>}
         */
        async function initFirebase() {
            try {
                // Check if Firebase SDK is loaded
                if (typeof window.firebase === 'undefined') {
                    throw new Error('Firebase SDK not loaded. Check CDN connection.');
                }

                // Initialize Firebase app
                window.firebase.app = window.firebase.initializeApp(firebaseConfig);
                window.firebase.auth = window.firebase.getAuth(window.firebase.app);
                window.firebase.db = window.firebase.getDatabase(window.firebase.app);

                // Set authentication persistence
                await window.firebase.setPersistence(
                    window.firebase.auth,
                    window.firebase.browserLocalPersistence
                );

                // Monitor connection status
                const connectedRef = window.firebase.ref(window.firebase.db, '.info/connected');
                window.firebase.onValue(connectedRef, (snapshot) => {
                    isOnline = snapshot.val() === true;
                    window.isOnline = isOnline; // Sync to window for testing
                    updateConnectionStatus();
                    if (isOnline) {
                        processOfflineQueue();
                    }
                });

                // Monitor authentication state
                window.firebase.onAuthStateChanged(window.firebase.auth, (user) => {
                    currentUser = user;
                    window.currentUser = user; // Sync to window for testing
                    handleAuthStateChange(user);
                });

                firebaseInitialized = true;
                window.firebaseInitialized = true; // Sync to window for testing
                console.log('✅ Firebase initialized successfully');

                // Load offline queue from localStorage
                loadOfflineQueue();

            } catch (error) {
                console.error('❌ Firebase initialization failed:', error);
                showToast('Firebase 初始化失败: ' + error.message, 'error');
                firebaseInitialized = false;
            }
        }

        /**
         * Handle authentication state changes
         * 处理认证状态变化
         * @param {Object|null} user - Firebase user object
         */
        async function handleAuthStateChange(user) {
            if (user) {
                console.log('✅ User logged in:', user.email);
                // Hide login UI, show main app
                hideAuthUI();

                // FIX: Process offline queue BEFORE loading projects to prevent race condition
                // This ensures deletions are applied to cloud before we load and merge
                if (isOnline && offlineQueue.length > 0) {
                    console.log('🔄 Processing offline queue before loading projects...');
                    await processOfflineQueue();
                }

                // Load user projects from Firebase (after offline queue is processed)
                await loadProjectsFromFirebase(user.uid);
            } else {
                console.log('ℹ️ User logged out');
                // Show login UI, hide main app
                showAuthUI();
                // Clear local projects
                projects = [];
                renderAllViews();
            }
        }

        /**
         * Update connection status indicator
         * 更新连接状态指示器
         */
        // Connection status update moved to line 2794 (consolidated duplicate)

        /**
         * Load offline queue from localStorage
         * 从 localStorage 加载离线队列
         */
        function loadOfflineQueue() {
            try {
                const saved = localStorage.getItem('firebase_offline_queue');
                if (saved) {
                    offlineQueue = JSON.parse(saved);
                    console.log(`📦 Loaded ${offlineQueue.length} operations from offline queue`);
                }
            } catch (error) {
                console.error('Failed to load offline queue:', error);
                offlineQueue = [];
            }
        }

        /**
         * Save offline queue to localStorage
         * 保存离线队列到 localStorage
         */
        function saveOfflineQueue() {
            try {
                localStorage.setItem('firebase_offline_queue', JSON.stringify(offlineQueue));
            } catch (error) {
                console.error('Failed to save offline queue:', error);
            }
        }

        /**
         * Process pending offline operations
         * 处理待处理的离线操作
         */
        async function processOfflineQueue() {
            if (!isOnline || offlineQueue.length === 0) return;

            console.log(`🔄 Processing ${offlineQueue.length} offline operations...`);
            const failedOps = [];

            for (const op of offlineQueue) {
                try {
                    if (op.type === 'set') {
                        const dbRef = window.firebase.ref(window.firebase.db, op.path);
                        await window.firebase.set(dbRef, op.data);
                    } else if (op.type === 'update') {
                        const dbRef = window.firebase.ref(window.firebase.db, op.path);
                        await window.firebase.update(dbRef, op.data);
                    } else if (op.type === 'delete') {
                        const dbRef = window.firebase.ref(window.firebase.db, op.path);
                        await window.firebase.remove(dbRef);
                    }
                    console.log(`✅ Synced operation ${op.id}`);
                } catch (error) {
                    console.error(`❌ Failed to sync operation ${op.id}:`, error);
                    failedOps.push(op);
                }
            }

            offlineQueue = failedOps;
            saveOfflineQueue();

            if (failedOps.length === 0) {
                showToast('✅ 所有离线更改已同步', 'success');
            } else {
                showToast(`⚠️ ${failedOps.length} 个操作同步失败`, 'warning');
            }
        }

        // ========================================
        // Authentication Functions (认证函数)
        // T010, T011, T012, T015, T016
        // ========================================

        /**
         * T010: Register new user with email and password
         * 注册新用户
         * @param {string} email - User email
         * @param {string} password - User password
         * @returns {Promise<Object>} User credential
         */
        async function registerUser(email, password) {
            try {
                console.log('🔐 Registering user:', email);
                const userCredential = await window.firebase.createUserWithEmailAndPassword(
                    window.firebase.auth,
                    email,
                    password
                );
                console.log('✅ User registered successfully:', userCredential.user.uid);
                showToast('✅ 注册成功！欢迎加入 Spec Kit', 'success');
                return userCredential;
            } catch (error) {
                console.error('❌ Registration failed:', error);
                throw error;
            }
        }

        /**
         * T011: Login user with email and password
         * 用户登录
         * @param {string} email - User email
         * @param {string} password - User password
         * @returns {Promise<Object>} User credential
         */
        async function loginUser(email, password) {
            try {
                console.log('🔐 Logging in user:', email);
                const userCredential = await window.firebase.signInWithEmailAndPassword(
                    window.firebase.auth,
                    email,
                    password
                );
                console.log('✅ User logged in successfully:', userCredential.user.uid);
                showToast('✅ 登录成功！', 'success');
                return userCredential;
            } catch (error) {
                console.error('❌ Login failed:', error);
                throw error;
            }
        }

        /**
         * T012: Logout current user
         * 用户登出
         * @returns {Promise<void>}
         */
        async function logoutUser() {
            try {
                console.log('🔐 Logging out user:', currentUser?.email);
                await window.firebase.signOut(window.firebase.auth);
                console.log('✅ User logged out successfully');
                showToast('✅ 已安全退出', 'success');
            } catch (error) {
                console.error('❌ Logout failed:', error);
                showToast('❌ 退出失败: ' + error.message, 'error');
            }
        }

        /**
         * T015: Display authentication error message
         * 显示认证错误消息
         * @param {string} errorCode - Firebase error code
         * @returns {string} User-friendly error message
         */
        function getAuthErrorMessage(errorCode) {
            const errorMessages = {
                'auth/email-already-in-use': '该邮箱已被注册，请直接登录',
                'auth/invalid-email': '邮箱格式不正确',
                'auth/operation-not-allowed': '邮箱/密码登录未启用，请联系管理员',
                'auth/weak-password': '密码强度不足，请使用至少 6 位字符',
                'auth/user-disabled': '该账户已被禁用',
                'auth/user-not-found': '用户不存在，请先注册',
                'auth/wrong-password': '密码错误，请重试',
                'auth/invalid-credential': '邮箱或密码错误',
                'auth/too-many-requests': '请求过于频繁，请稍后再试',
                'auth/network-request-failed': '网络连接失败，请检查网络',
                'auth/popup-closed-by-user': '登录窗口已关闭',
                'auth/cancelled-popup-request': '登录请求已取消'
            };
            return errorMessages[errorCode] || `认证错误: ${errorCode}`;
        }

        /**
         * Display error in auth form
         * 在认证表单中显示错误
         * @param {string} message - Error message
         */
        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
            setTimeout(() => {
                errorEl.classList.remove('show');
            }, 5000);
        }

        /**
         * Clear authentication error
         * 清除认证错误
         */
        function clearAuthError() {
            const errorEl = document.getElementById('authError');
            errorEl.classList.remove('show');
        }

        /**
         * T016: Show authentication UI (login/register forms)
         * 显示认证界面
         */
        function showAuthUI() {
            const authOverlay = document.getElementById('authOverlay');
            const mainApp = document.getElementById('mainApp');
            const userInfoInline = document.getElementById('userInfoInline');

            authOverlay.classList.remove('hidden');
            if (mainApp) mainApp.style.display = 'none';
            if (userInfoInline) userInfoInline.classList.remove('show');

            console.log('🔓 Showing authentication UI');
        }

        /**
         * T016: Hide authentication UI and show main app
         * 隐藏认证界面并显示主应用
         */
        function hideAuthUI() {
            const authOverlay = document.getElementById('authOverlay');
            const mainApp = document.getElementById('mainApp');
            const userInfoInline = document.getElementById('userInfoInline');
            const userEmailInline = document.getElementById('userEmailInline');

            authOverlay.classList.add('hidden');
            if (mainApp) mainApp.style.display = 'block';

            // Show inline user info in header
            if (currentUser && userEmailInline && userInfoInline) {
                userEmailInline.textContent = currentUser.email;
                userInfoInline.classList.add('show');
            }

            console.log('🔓 Hiding authentication UI, showing user:', currentUser?.email);
        }

        /**
         * Switch between login and register tabs
         * 切换登录/注册标签
         * @param {string} tab - 'login' or 'register'
         */
        function switchAuthTab(tab) {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const tabs = document.querySelectorAll('.auth-tab');

            clearAuthError();

            if (tab === 'login') {
                loginForm.classList.add('active');
                registerForm.classList.remove('active');
                tabs[0].classList.add('active');
                tabs[1].classList.remove('active');
            } else {
                registerForm.classList.add('active');
                loginForm.classList.remove('active');
                tabs[1].classList.add('active');
                tabs[0].classList.remove('active');
            }
        }

        /**
         * Handle login form submission
         * 处理登录表单提交
         * @param {Event} event - Form submit event
         */
        async function handleLogin(event) {
            event.preventDefault();
            clearAuthError();

            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const button = document.getElementById('loginButton');

            button.disabled = true;
            button.textContent = '登录中...';

            try {
                await loginUser(email, password);
                // Auth state change will trigger hideAuthUI()
            } catch (error) {
                showAuthError(getAuthErrorMessage(error.code));
            } finally {
                button.disabled = false;
                button.textContent = '登录';
            }
        }

        /**
         * Handle register form submission
         * 处理注册表单提交
         * @param {Event} event - Form submit event
         */
        async function handleRegister(event) {
            event.preventDefault();
            clearAuthError();

            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const button = document.getElementById('registerButton');

            // Validate password match
            if (password !== passwordConfirm) {
                showAuthError('两次输入的密码不一致');
                return;
            }

            button.disabled = true;
            button.textContent = '注册中...';

            try {
                await registerUser(email, password);
                // Auth state change will trigger hideAuthUI()
            } catch (error) {
                showAuthError(getAuthErrorMessage(error.code));
            } finally {
                button.disabled = false;
                button.textContent = '注册';
            }
        }

        /**
         * Handle logout button click
         * 处理登出按钮点击
         */
        async function handleLogout() {
            const confirmed = await showConfirm({
                title: '退出登录',
                message: '确定要退出登录吗？',
                confirmText: '退出',
                cancelText: '取消'
            });
            if (confirmed) {
                await logoutUser();
                // Auth state change will trigger showAuthUI()
            }
        }

        /**
         * Update connection status indicator
         * 更新连接状态指示器
         */
        function updateConnectionStatus() {
            const statusEl = document.getElementById('connectionStatus');
            const dotEl = statusEl?.querySelector('.status-dot');
            const textEl = statusEl?.querySelector('.status-text');

            console.log('🔍 updateConnectionStatus called:', {
                isOnline,
                hasStatusEl: !!statusEl,
                hasDotEl: !!dotEl,
                hasTextEl: !!textEl
            });

            if (!statusEl) {
                console.warn('⚠️ connectionStatus element not found');
                return;
            }
            if (!dotEl) {
                console.warn('⚠️ status-dot element not found');
                return;
            }
            if (!textEl) {
                console.warn('⚠️ status-text element not found');
                return;
            }

            statusEl.style.display = 'flex';

            // Handle three states: online (true), offline (false), unknown (undefined)
            if (isOnline === true) {
                dotEl.classList.remove('offline');
                textEl.textContent = '在线';
                console.log('✅ Connection status: 🟢 在线');
            } else if (isOnline === false) {
                dotEl.classList.add('offline');
                textEl.textContent = '离线';
                console.log('⚠️ Connection status: 🔴 离线');
            } else {
                // isOnline is undefined/null - still connecting
                dotEl.classList.remove('offline');
                textEl.textContent = '连接中...';
                console.log('⏳ Connection status: 🔄 连接中...');
            }
        }

        // ========================================
        // Firebase Data Persistence Functions (数据持久化函数)
        // T017, T018, T019, T020, T021, T025, T026, T027, T028
        // ========================================

        /**
         * T017: Save project to Firebase
         * 保存项目到 Firebase
         * @param {string} userId - User ID
         * @param {string} projectId - Project ID
         * @param {Object} projectData - Project data
         * @returns {Promise<void>}
         */
        async function saveProjectToFirebase(userId, projectId, projectData) {
            try {
                // T020-T021: Use server timestamp for lastModified
                const dataToSave = {
                    ...projectData,
                    updatedAt: Date.now(),
                    createdAt: projectData.createdAt || Date.now(),
                    // Use Firebase server timestamp for cloud-first sync
                    lastModified: window.firebase.serverTimestamp()
                };

                // T021: Remove migration flag after setting server timestamp
                if (dataToSave.needsTimestampUpdate) {
                    delete dataToSave.needsTimestampUpdate;
                }

                const dataWithTimestamp = dataToSave;

                const projectRef = window.firebase.ref(
                    window.firebase.db,
                    `users/${userId}/projects/${projectId}`
                );

                if (isOnline && firebaseInitialized) {
                    await window.firebase.set(projectRef, dataWithTimestamp);
                    console.log(`✅ Project ${projectId} saved to Firebase`);
                } else {
                    // Add to offline queue
                    queueOfflineOperation('set', `users/${userId}/projects/${projectId}`, dataWithTimestamp);
                    console.log(`📦 Project ${projectId} queued for later sync`);
                }
            } catch (error) {
                console.error(`❌ Failed to save project ${projectId}:`, error);
                // Add to offline queue on failure
                queueOfflineOperation('set', `users/${userId}/projects/${projectId}`, projectData);
                throw error;
            }
        }

        /**
         * T018: Load all projects from Firebase
         * 从 Firebase 加载所有项目
         * @param {string} userId - User ID
         * @returns {Promise<Array>} Array of projects
         */
        async function loadProjectsFromFirebase(userId) {
            try {
                console.log(`📥 Loading projects for user: ${userId}`);

                // T027: Load from both Firebase and localStorage for conflict resolution
                const projectsRef = window.firebase.ref(
                    window.firebase.db,
                    `users/${userId}/projects`
                );

                const snapshot = await window.firebase.get(projectsRef);

                if (snapshot.exists()) {
                    const projectsObj = snapshot.val();
                    let cloudProjects = Object.values(projectsObj);
                    console.log(`✅ Loaded ${cloudProjects.length} projects from Firebase`);

                    // Migrate cloud projects
                    cloudProjects = cloudProjects.map(migrateProjectSchema);

                    // T027: Load local projects from localStorage
                    const saved = localStorage.getItem('speckit_projects');
                    let localProjects = [];
                    if (saved) {
                        localProjects = JSON.parse(saved).map(migrateProjectSchema);
                        console.log(`💾 Loaded ${localProjects.length} projects from localStorage`);
                    }

                    // T027: Use cloud-first conflict resolution
                    projects = conflictResolveProjects(cloudProjects, localProjects);

                    // T028: Save merged result back to localStorage (cloud authority)
                    localStorage.setItem('speckit_projects', JSON.stringify(projects));
                    console.log(`🔄 Merged and saved ${projects.length} projects to localStorage`);

                    renderAllViews();

                    return projects; // Return merged projects
                } else {
                    console.log('ℹ️ No projects found in Firebase');

                    // T026: Check for localStorage migration
                    await migrateLocalStorageToFirebase(userId);

                    return [];
                }
            } catch (error) {
                console.error('❌ Failed to load projects:', error);
                showToast('❌ 加载项目失败: ' + error.message, 'error');
                return [];
            }
        }

        /**
         * T019: Update project in Firebase
         * 更新 Firebase 中的项目
         * @param {string} userId - User ID
         * @param {string} projectId - Project ID
         * @param {Object} updates - Partial updates
         * @returns {Promise<void>}
         */
        async function updateProjectInFirebase(userId, projectId, updates) {
            try {
                // T025: Add timestamp
                const updatesWithTimestamp = {
                    ...updates,
                    updatedAt: Date.now()
                };

                const projectRef = window.firebase.ref(
                    window.firebase.db,
                    `users/${userId}/projects/${projectId}`
                );

                if (isOnline && firebaseInitialized) {
                    await window.firebase.update(projectRef, updatesWithTimestamp);
                    console.log(`✅ Project ${projectId} updated in Firebase`);
                } else {
                    // Add to offline queue
                    queueOfflineOperation('update', `users/${userId}/projects/${projectId}`, updatesWithTimestamp);
                    console.log(`📦 Project ${projectId} update queued`);
                }
            } catch (error) {
                console.error(`❌ Failed to update project ${projectId}:`, error);
                // Add to offline queue on failure
                queueOfflineOperation('update', `users/${userId}/projects/${projectId}`, updates);
                throw error;
            }
        }

        /**
         * T020: Delete project from Firebase
         * 从 Firebase 删除项目
         * @param {string} userId - User ID
         * @param {string} projectId - Project ID
         * @returns {Promise<void>}
         */
        async function deleteProjectFromFirebase(userId, projectId) {
            try {
                const projectRef = window.firebase.ref(
                    window.firebase.db,
                    `users/${userId}/projects/${projectId}`
                );

                // CRITICAL FIX: Always attempt deletion, don't check isOnline
                // Firebase SDK handles offline persistence automatically
                // This prevents race conditions where isOnline status changes between calls
                await window.firebase.remove(projectRef);
                console.log(`✅ Project ${projectId} deleted from Firebase`);
            } catch (error) {
                console.error(`❌ Failed to delete project ${projectId}:`, error);
                // Only add to offline queue if deletion fails
                queueOfflineOperation('delete', `users/${userId}/projects/${projectId}`, null);
                console.log(`📦 Project ${projectId} deletion queued for retry`);
                throw error;
            }
        }

        /**
         * Queue offline operation for later sync
         * 将离线操作加入队列以便稍后同步
         * @param {string} type - Operation type: 'set', 'update', or 'delete'
         * @param {string} path - Firebase path
         * @param {Object|null} data - Data to save
         */
        function queueOfflineOperation(type, path, data) {
            const operation = {
                id: `op_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                timestamp: new Date().toISOString(),
                type,
                path,
                data,
                retryCount: 0,
                status: 'pending'
            };

            offlineQueue.push(operation);
            saveOfflineQueue();

            // T024: Exponential backoff - limit queue size
            if (offlineQueue.length > 100) {
                console.warn('⚠️ Offline queue exceeds 100 operations');
                showToast('⚠️ 离线队列已满，部分操作可能丢失', 'warning');
                offlineQueue = offlineQueue.slice(-100); // Keep last 100
                saveOfflineQueue();
            }

            console.log(`📦 Operation ${operation.id} added to offline queue (${offlineQueue.length} total)`);
        }

        /**
         * T026: Migrate localStorage data to Firebase
         * 迁移 localStorage 数据到 Firebase
         * @param {string} userId - User ID
         * @returns {Promise<void>}
         */
        async function migrateLocalStorageToFirebase(userId) {
            try {
                // Check if localStorage has data
                const localData = localStorage.getItem('speckit_projects');
                if (!localData) {
                    console.log('ℹ️ No localStorage data to migrate');
                    return;
                }

                const localProjects = JSON.parse(localData);
                if (!Array.isArray(localProjects) || localProjects.length === 0) {
                    console.log('ℹ️ No valid projects in localStorage');
                    return;
                }

                console.log(`📤 Found ${localProjects.length} projects in localStorage`);

                // T027: Show conflict resolution modal
                const shouldMigrate = await showMigrationModal(localProjects.length);
                if (!shouldMigrate) {
                    console.log('ℹ️ User cancelled migration');
                    return;
                }

                // Migrate each project
                let migrated = 0;
                for (const project of localProjects) {
                    try {
                        const projectId = project.id || `project_${Date.now()}_${migrated}`;
                        const projectData = {
                            ...project,
                            id: projectId,
                            migratedAt: Date.now(),
                            migratedFrom: 'localStorage'
                        };

                        await saveProjectToFirebase(userId, projectId, projectData);
                        migrated++;
                    } catch (error) {
                        console.error('❌ Failed to migrate project:', error);
                    }
                }

                if (migrated > 0) {
                    console.log(`✅ Migrated ${migrated} projects from localStorage to Firebase`);
                    showToast(`✅ 成功迁移 ${migrated} 个项目到云端`, 'success');

                    // Reload projects
                    await loadProjectsFromFirebase(userId);

                    // Optionally clear localStorage
                    if (confirm('迁移成功！是否清除本地存储的旧数据？')) {
                        localStorage.removeItem('speckit_projects');
                        console.log('✅ Cleared localStorage');
                    }
                }
            } catch (error) {
                console.error('❌ Migration failed:', error);
                showToast('❌ 数据迁移失败: ' + error.message, 'error');
            }
        }

        /**
         * T027: Show migration confirmation modal
         * 显示迁移确认模态框
         * @param {number} count - Number of projects to migrate
         * @returns {Promise<boolean>} User's decision
         */
        function showMigrationModal(count) {
            return new Promise((resolve) => {
                const message = `检测到本地存储有 ${count} 个项目。\n是否迁移到云端？`;
                const result = confirm(message);
                resolve(result);
            });
        }

        /**
         * T028: Last-write-wins conflict resolution (implicit via timestamp)
         * 最后写入获胜的冲突解决（通过时间戳隐式实现）
         * Note: Firebase Realtime Database handles this automatically with our updatedAt timestamps
         */

        // ========================================
        // T001: Color Palette for Category Distinction (Feature 006)
        // ========================================

        /**
         * Predefined color palette for category color assignment
         * All colors are WCAG AA compliant (contrast ratio ≥4.5:1 on white background)
         * @constant {Array<{index: number, color: string, name: string, contrastRatio: number}>}
         */
        const COLOR_PALETTE = [
            { index: 0, color: '#2563eb', name: 'Blue', contrastRatio: 7.0 },
            { index: 1, color: '#10b981', name: 'Green', contrastRatio: 5.8 },
            { index: 2, color: '#f59e0b', name: 'Amber', contrastRatio: 4.8 },
            { index: 3, color: '#8b5cf6', name: 'Purple', contrastRatio: 6.2 },
            { index: 4, color: '#ef4444', name: 'Red', contrastRatio: 5.5 },
            { index: 5, color: '#06b6d4', name: 'Cyan', contrastRatio: 6.1 },
            { index: 6, color: '#ec4899', name: 'Pink', contrastRatio: 5.9 },
            { index: 7, color: '#84cc16', name: 'Lime', contrastRatio: 5.2 },
            { index: 8, color: '#f97316', name: 'Orange', contrastRatio: 5.0 },
            { index: 9, color: '#6366f1', name: 'Indigo', contrastRatio: 6.8 },
            { index: 10, color: '#14b8a6', name: 'Teal', contrastRatio: 5.9 },
            { index: 11, color: '#a855f7', name: 'Fuchsia', contrastRatio: 6.0 },
            { index: 12, color: '#0ea5e9', name: 'Sky', contrastRatio: 6.5 },
            { index: 13, color: '#22c55e', name: 'Emerald', contrastRatio: 5.6 },
            { index: 14, color: '#fb923c', name: 'Peach', contrastRatio: 4.9 }
        ];

        // ========================================
        // Feature 007-1-20-20: Multi-Column Layout Constants
        // ========================================

        // T001-T003: Column count constraints for multi-column layout
        const MIN_COLUMNS = 1;
        const MAX_COLUMNS = 20;
        const DEFAULT_COLUMNS = 4;

        // ========================================
        // Existing Project Data & State
        // ========================================

        // 项目数据存储
        let projects = [];
        let commands = []; // T006/T007: Command Library storage
        let currentTab = 'overview';
        let currentProjectId = null;
        let currentIterationId = null;

        // 命令步骤定义
        const commandSteps = [
            {
                id: 'init-new',
                phase: 'init',
                stepNumber: '0',
                title: '项目初始化',
                subtitle: '新项目 (Greenfield)',
                desc: '创建新目录并注入 Spec Kit 模板和脚本',
                command: 'specify init',
                hasInput: true,
                inputPlaceholder: '输入项目名称',
                hasNotes: true,
                note: '💡 新项目必须指定项目名称，系统会自动创建目录'
            },
            {
                id: 'init-existing',
                phase: 'init',
                stepNumber: '0',
                title: '项目初始化',
                subtitle: '现有项目 (Brownfield)',
                desc: '在当前目录中合并 Spec Kit 配置',
                command: 'specify init .',
                hasInput: false,
                hasNotes: true,
                note: '💡 在已有项目根目录执行，会合并配置而不覆盖现有文件'
            },
            {
                id: 'constitution',
                phase: 'architecture',
                stepNumber: 'I',
                title: '定义架构 DNA',
                subtitle: 'Constitution',
                desc: '创建项目的治理原则、代码质量标准、测试要求和性能目标',
                command: '/speckit.constitution',
                hasInput: true,
                hasNotes: true,
                inputPlaceholder: '输入架构描述（可选）',
                note: '⚠️ AI 代理必须遵守这些原则，违反将在 /plan 和 /implement 中标记为 CRITICAL'
            },
            {
                id: 'specify',
                phase: 'development',
                stepNumber: 'II',
                title: '定义规范',
                subtitle: 'Specify (What/Why)',
                desc: '描述功能的用户故事、业务需求和期望成果，不涉及技术栈',
                command: '/speckit.specify',
                hasInput: true,
                hasNotes: true,
                inputPlaceholder: '输入功能描述（可选）',
                note: '✅ 自动创建 Git 分支（如 001-feature-name）和规范文件 specs/[branch]/spec.md'
            },
            {
                id: 'clarify',
                phase: 'development',
                stepNumber: 'III',
                title: '澄清需求',
                subtitle: 'Clarify (可选)',
                desc: '解决 spec.md 中的模糊点和 [NEEDS CLARIFICATION] 标记',
                command: '/speckit.clarify',
                hasInput: false,
                hasNotes: true,
                note: '💡 推荐使用，通过结构化问答（最多5个问题）细化需求，避免返工'
            },
            {
                id: 'plan',
                phase: 'development',
                stepNumber: 'IV',
                title: '制定计划',
                subtitle: 'Plan (How/Tech Stack)',
                desc: '明确技术栈、架构模式、性能约束和集成点',
                command: '/speckit.plan',
                hasInput: true,
                hasNotes: true,
                inputPlaceholder: '输入技术栈或约束（可选）',
                note: '📁 生成 plan.md、data-model.md、research.md 和 contracts/ 等工件'
            },
            {
                id: 'tasks',
                phase: 'development',
                stepNumber: 'V',
                title: '任务分解',
                subtitle: 'Tasks',
                desc: '将计划分解为可执行步骤（T001, T002...），按 TDD 模式排列',
                command: '/speckit.tasks',
                hasInput: false,
                hasNotes: true,
                note: '📝 生成 tasks.md，包含执行顺序和并行标记 [P]'
            },
            {
                id: 'analyze',
                phase: 'development',
                stepNumber: 'VI',
                title: '一致性分析',
                subtitle: 'Analyze (可选)',
                desc: '非破坏性检查 spec/plan/tasks 是否与 constitution.md 一致',
                command: '/speckit.analyze',
                hasInput: false,
                hasNotes: true,
                note: '🔍 发现矛盾或违反架构原则时报告 CRITICAL 警告'
            },
            {
                id: 'implement',
                phase: 'development',
                stepNumber: 'VII',
                title: '实施执行',
                subtitle: 'Implement',
                desc: 'AI 根据 tasks.md 生成代码，建议分批执行（如 T001 to T005）',
                command: '/speckit.implement',
                hasInput: true,
                hasNotes: true,
                inputPlaceholder: '输入任务范围（如 T001 to T005）',
                note: '🧪 遵循 TDD：先写失败测试，再实现功能使其通过'
            },
            {
                id: 'repair',
                phase: 'iteration',
                stepNumber: 'VIII',
                title: '迭代与修复',
                subtitle: 'Error Feedback',
                desc: '测试应用并解决运行时错误，持续改进代码质量',
                command: '复制错误信息并粘贴给 AI 进行修复',
                hasInput: false,
                hasNotes: true,
                note: '🐛 将错误信息粘贴给 AI，或手动更新 spec.md/plan.md 澄清指示'
            },
            {
                id: 'merge',
                phase: 'iteration',
                stepNumber: 'IX',
                title: '结束与循环',
                subtitle: 'Merge & Next',
                desc: '合并功能分支，开始下一个功能开发循环',
                command: 'git merge',
                hasInput: true,
                hasNotes: true,
                inputPlaceholder: '输入分支名称',
                note: '♻️ 下一功能从步骤 II (/speckit.specify) 开始新循环'
            }
        ];

        const phases = {
            init: { title: '🎯 初始化阶段', icon: '🎯' },
            architecture: { title: '🏛️ 架构约束阶段', icon: '🏛️' },
            development: { title: '⚡ 功能开发阶段', icon: '⚡' },
            iteration: { title: '🔄 迭代优化阶段', icon: '🔄' }
        };

        // 全局变量
        let pendingImportData = null;
        let expandedProjects = new Set(); // 记录展开的项目
        let selectedProjectId = null;
        let selectedIterationId = null;

        // ========================================
        // Feature 007-1-20-20: Multi-Column Layout Module Architecture
        // Constitution Principle VI: Modularity Mandate
        // Constitution Principle VII: Separation of Concerns
        // ========================================

        // ========== DATA ACCESS LAYER: Column Management Module ==========
        /**
         * Responsibilities: Read/write column preference from localStorage ONLY.
         * Prohibited: DOM manipulation, business logic calculations.
         * Functions: columnLoadPreference(), columnSavePreference()
         */

        /**
         * T020 [US1]: Load column count preference from localStorage
         * @returns {number} Column count (1-20), or default (4) if not found/invalid
         */
        function columnLoadPreference() {
            try {
                const stored = localStorage.getItem('speckit_column_count');

                // Handle null/undefined (first visit)
                if (stored === null || stored === undefined) {
                    return DEFAULT_COLUMNS;
                }

                // Parse and validate
                const parsed = parseInt(stored, 10);

                // Handle NaN or invalid numbers
                if (isNaN(parsed)) {
                    console.warn('Invalid column count in localStorage, using default');
                    return DEFAULT_COLUMNS;
                }

                // Clamp to valid range
                if (parsed < MIN_COLUMNS || parsed > MAX_COLUMNS) {
                    console.warn(`Column count ${parsed} out of range [${MIN_COLUMNS}, ${MAX_COLUMNS}], using default`);
                    return DEFAULT_COLUMNS;
                }

                return parsed;

            } catch (error) {
                console.error('Error reading column preference from localStorage:', error);
                return DEFAULT_COLUMNS;
            }
        }

        /**
         * T021 [US1]: Save column count preference to localStorage
         * @param {number} columnCount - Desired column count (1-20)
         * @returns {boolean} true if saved successfully, false otherwise
         */
        function columnSavePreference(columnCount) {
            // Validate type
            if (typeof columnCount !== 'number' || isNaN(columnCount)) {
                console.error('Invalid column count type:', columnCount);
                return false;
            }

            // Clamp to valid range and floor to integer
            const clamped = Math.max(MIN_COLUMNS, Math.min(MAX_COLUMNS, Math.floor(columnCount)));

            try {
                localStorage.setItem('speckit_column_count', clamped.toString());
                return true;
            } catch (error) {
                console.error('Error writing column preference to localStorage:', error);
                return false;
            }
        }

        // ========== BUSINESS LOGIC LAYER: Layout Calculation Module ==========
        /**
         * Responsibilities: Pure calculations for grid layout and font sizes.
         * Prohibited: DOM manipulation, localStorage access.
         * Functions: layoutCalculateGrid(), layoutCalculateFontSizes()
         */

        /**
         * T031 [US2]: Calculate CSS Grid layout parameters based on column count
         * T041 [US3]: Added validation logic for grid layout
         * @param {number} columnCount - Column count (1-20)
         * @returns {Object} Grid layout parameters
         */
        function layoutCalculateGrid(columnCount) {
            // Clamp to valid range (safety check)
            const count = Math.max(MIN_COLUMNS, Math.min(MAX_COLUMNS, columnCount));

            // T041 [US3]: CSS Grid template - always use minmax(0, 1fr) to prevent overflow
            const gridTemplateColumns = `repeat(${count}, minmax(0, 1fr))`;

            // Calculate font size using segmented scaling
            let fontSize;
            if (count <= 4) {
                fontSize = 16; // Constant for 1-4 columns
            } else if (count <= 8) {
                fontSize = Math.max(14, 20 - (count - 4) * 0.5);
            } else if (count <= 12) {
                fontSize = Math.max(12, 14 - (count - 8) * 0.5);
            } else {
                fontSize = Math.max(10, 12 - (count - 12) * 0.25);
            }

            // Calculate responsive parameters
            const lineHeight = count <= 4 ? 1.5 : (count <= 12 ? 1.3 : 1.2);
            const itemPadding = fontSize >= 14 ? '0.75rem' : '0.5rem';

            // T041 [US3]: Validate gap value is rem-based and itemPadding never causes overflow
            const gap = '1rem'; // Rem-based for responsive scaling

            return {
                columnCount: count,
                gridTemplateColumns,
                gap,
                itemPadding,
                fontSize,
                lineHeight
            };
        }

        /**
         * T032 [US2]: Calculate detailed font size parameters for different text elements
         * T042 [US3]: Added boundary checks for font sizes
         * @param {number} columnCount - Column count (1-20)
         * @returns {Object} Font size parameters
         */
        function layoutCalculateFontSizes(columnCount) {
            // Clamp to valid range
            const count = Math.max(MIN_COLUMNS, Math.min(MAX_COLUMNS, columnCount));

            let labelSize, textSize, headerSize, lineHeight;
            const minReadableSize = 10; // T042 [US3]: Minimum font size for accessibility

            // Segmented scaling for different column ranges
            if (count <= 4) {
                // 1-4 columns: Maximum readability
                labelSize = 16;
                textSize = 14;
                headerSize = 18;
                lineHeight = 1.5;
            } else if (count <= 8) {
                // 5-8 columns: Gentle reduction
                const factor = (count - 4) * 0.5;
                labelSize = Math.max(14, 20 - factor);
                textSize = Math.max(12, 18 - factor);
                headerSize = Math.max(16, 22 - factor);
                lineHeight = 1.4;
            } else if (count <= 12) {
                // 9-12 columns: Compact territory
                const factor = (count - 8) * 0.5;
                labelSize = Math.max(12, 14 - factor);
                textSize = Math.max(11, 12 - factor);
                headerSize = Math.max(14, 16 - factor);
                lineHeight = 1.3;
            } else {
                // 13-20 columns: Dense for power users
                const factor = (count - 12) * 0.25;
                labelSize = Math.max(10, 12 - factor);
                textSize = Math.max(10, 11 - factor);
                headerSize = Math.max(12, 14 - factor);
                lineHeight = 1.2;
            }

            // T042 [US3]: Verify all font sizes >= minReadableSize and lineHeight >= 1.2
            labelSize = Math.max(minReadableSize, Math.floor(labelSize));
            textSize = Math.max(minReadableSize, Math.floor(textSize));
            headerSize = Math.max(minReadableSize, Math.floor(headerSize));
            lineHeight = Math.max(1.2, lineHeight);

            return {
                columnCount: count,
                commandLabelSize: labelSize,
                commandTextSize: textSize,
                categoryHeaderSize: headerSize,
                lineHeight,
                minReadableSize
            };
        }

        // ========== PRESENTATION LAYER: Command Grid Rendering Module ==========
        /**
         * Responsibilities: Update DOM with calculated layout.
         * Prohibited: Direct localStorage access (use column* functions), business logic calculations.
         * Functions: renderCommandGrid(), renderColumnSelector(), handleColumnCountChange(), handleColumnCountSet()
         */

        /**
         * T023 [US1]: Render column count selector UI control
         * @returns {void}
         */
        function renderColumnSelector() {
            const container = document.getElementById('command-controls');
            if (!container) return;

            // DATA ACCESS LAYER: Get current preference
            const currentCount = columnLoadPreference();

            const selectorHTML = `
                <div class="column-selector">
                    <label for="column-count-input">列数 (Columns):</label>
                    <input type="range"
                           id="column-count-input"
                           min="${MIN_COLUMNS}"
                           max="${MAX_COLUMNS}"
                           value="${currentCount}"
                           oninput="handleColumnCountChange(this.value)">
                    <span id="column-count-display" class="column-selector-display">${currentCount}</span>
                    <button class="column-preset-btn ${currentCount === 1 ? 'active' : ''}"
                            onclick="handleColumnCountSet(1)">1</button>
                    <button class="column-preset-btn ${currentCount === 4 ? 'active' : ''}"
                            onclick="handleColumnCountSet(4)">4</button>
                    <button class="column-preset-btn ${currentCount === 8 ? 'active' : ''}"
                            onclick="handleColumnCountSet(8)">8</button>
                    <button class="column-preset-btn ${currentCount === 12 ? 'active' : ''}"
                            onclick="handleColumnCountSet(12)">12</button>
                    <button class="column-preset-btn ${currentCount === 20 ? 'active' : ''}"
                            onclick="handleColumnCountSet(20)">20</button>
                </div>
            `;

            // Insert before command list
            const existingSelector = container.querySelector('.column-selector');
            if (existingSelector) {
                existingSelector.outerHTML = selectorHTML;
            } else {
                container.insertAdjacentHTML('afterbegin', selectorHTML);
            }
        }

        /**
         * T024 [US1]: Handle slider input change (live preview, no save)
         * @param {string} value - Slider value (1-20)
         */
        function handleColumnCountChange(value) {
            const count = parseInt(value, 10);

            // Update display
            const display = document.getElementById('column-count-display');
            if (display) {
                display.textContent = count;
            }

            // Update active button
            document.querySelectorAll('.column-preset-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Live preview without saving
            const layout = layoutCalculateGrid(count);
            const fonts = layoutCalculateFontSizes(count);

            const commandList = document.getElementById('command-list');
            if (commandList) {
                commandList.style.gridTemplateColumns = layout.gridTemplateColumns;
                commandList.style.gap = layout.gap;

                // Apply font sizes to all elements
                const labels = commandList.querySelectorAll('.command-label');
                labels.forEach(label => {
                    label.style.fontSize = fonts.commandLabelSize + 'px';
                });

                const texts = commandList.querySelectorAll('.command-text');
                texts.forEach(text => {
                    text.style.fontSize = fonts.commandTextSize + 'px';
                    text.style.lineHeight = fonts.lineHeight;
                });

                const headers = commandList.querySelectorAll('.command-category-header');
                headers.forEach(header => {
                    header.style.fontSize = fonts.categoryHeaderSize + 'px';
                });
            }
        }

        /**
         * T025 [US1]: Handle preset button click or slider release (save)
         * @param {number} count - Column count to set (1-20)
         */
        function handleColumnCountSet(count) {
            // DATA ACCESS LAYER: Save preference
            const saved = columnSavePreference(count);
            if (!saved) {
                console.warn('Failed to save column preference');
            }

            // Update slider and display
            const slider = document.getElementById('column-count-input');
            const display = document.getElementById('column-count-display');
            if (slider) slider.value = count;
            if (display) display.textContent = count;

            // Update active button
            document.querySelectorAll('.column-preset-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent, 10) === count) {
                    btn.classList.add('active');
                }
            });

            // PRESENTATION LAYER: Re-render with new layout
            renderCommandLibrary();
        }

        // ============ Toast 通知系统 ============
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast toast-${type} show`;

            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============ Custom Confirm Dialog 自定义确认对话框 ============
        function showConfirm(options) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('confirmDialogOverlay');
                const title = document.getElementById('confirmDialogTitle');
                const message = document.getElementById('confirmDialogMessage');
                const cancelBtn = document.getElementById('confirmDialogCancel');
                const confirmBtn = document.getElementById('confirmDialogConfirm');

                // Set content
                title.textContent = options.title || '确认操作';
                message.textContent = options.message || '确定要继续吗？';
                cancelBtn.textContent = options.cancelText || '取消';
                confirmBtn.textContent = options.confirmText || '确认';

                // Set button style (danger or normal)
                confirmBtn.className = 'confirm-dialog-btn confirm-dialog-btn-confirm';
                if (options.danger) {
                    confirmBtn.classList.add('danger');
                }

                // Show dialog
                overlay.classList.add('show');

                // Handle cancel
                const handleCancel = () => {
                    overlay.classList.remove('show');
                    cancelBtn.removeEventListener('click', handleCancel);
                    confirmBtn.removeEventListener('click', handleConfirm);
                    overlay.removeEventListener('click', handleOverlayClick);
                    resolve(false);
                };

                // Handle confirm
                const handleConfirm = () => {
                    overlay.classList.remove('show');
                    cancelBtn.removeEventListener('click', handleCancel);
                    confirmBtn.removeEventListener('click', handleConfirm);
                    overlay.removeEventListener('click', handleOverlayClick);
                    resolve(true);
                };

                // Handle overlay click (click outside)
                const handleOverlayClick = (e) => {
                    if (e.target === overlay) {
                        handleCancel();
                    }
                };

                // Add event listeners
                cancelBtn.addEventListener('click', handleCancel);
                confirmBtn.addEventListener('click', handleConfirm);
                overlay.addEventListener('click', handleOverlayClick);
            });
        }

        // ============ T045: Loading Overlay 加载状态 ============
        function showLoading(message = '加载中...') {
            const overlay = document.getElementById('loadingOverlay');
            const text = document.getElementById('loadingText');
            if (text) text.textContent = message;
            if (overlay) overlay.classList.add('active');
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        // ============ 导出功能 (T003, T004) ============
        function generateExportData(projectIds = null) {
            const exportProjects = projectIds
                ? projects.filter(p => projectIds.includes(p.id))
                : projects;

            return {
                version: '1.0',
                exportDate: new Date().toISOString(),
                projects: exportProjects
            };
        }

        function exportAllProjects() {
            if (projects.length === 0) {
                showToast('没有可导出的项目数据', 'warning');
                return;
            }

            const exportData = generateExportData();
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `speckit-backup-${timestamp}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`✅ 已导出 ${projects.length} 个项目`, 'success');
        }

        function exportProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                showToast('项目不存在', 'error');
                return;
            }

            const exportData = generateExportData([projectId]);
            const jsonString = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `speckit-${project.name}-${timestamp}.json`;

            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast(`✅ 已导出项目: ${project.name}`, 'success');
        }

        // ============ 导入功能 (T005, T006, T007, T008) ============
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
            document.getElementById('importFileInput').value = '';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('confirmImportBtn').disabled = true;
            pendingImportData = null;
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
            pendingImportData = null;
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    const validation = validateProjectData(data);

                    if (!validation.valid) {
                        showToast(validation.error, 'error');
                        document.getElementById('importPreview').style.display = 'none';
                        document.getElementById('confirmImportBtn').disabled = true;
                        return;
                    }

                    // 显示预览
                    pendingImportData = validation.data;
                    const totalIterations = pendingImportData.projects.reduce((sum, p) => sum + p.iterations.length, 0);

                    document.getElementById('importPreviewContent').innerHTML = `
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <div><strong>文件版本:</strong> ${pendingImportData.version}</div>
                            <div><strong>导出时间:</strong> ${new Date(pendingImportData.exportDate).toLocaleString('zh-CN')}</div>
                            <div><strong>包含项目:</strong> ${pendingImportData.projects.length} 个</div>
                            <div><strong>包含迭代:</strong> ${totalIterations} 个</div>
                            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                <strong>项目列表:</strong>
                                <ul style="margin-top: 6px; padding-left: 20px;">
                                    ${pendingImportData.projects.map(p => `<li>${p.name} (${p.iterations.length} 个迭代)</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                    `;

                    document.getElementById('importPreview').style.display = 'block';
                    document.getElementById('confirmImportBtn').disabled = false;
                } catch (err) {
                    showToast('文件格式错误: 无法解析 JSON', 'error');
                    document.getElementById('importPreview').style.display = 'none';
                    document.getElementById('confirmImportBtn').disabled = true;
                }
            };

            reader.readAsText(file);
        }

        // 三层数据验证 (T006)
        function validateProjectData(data) {
            // 第一层: 基本格式验证
            if (!data || typeof data !== 'object') {
                return { valid: false, error: '数据格式错误: 不是有效的 JSON 对象' };
            }

            if (!data.version || !data.exportDate || !Array.isArray(data.projects)) {
                return { valid: false, error: '数据格式错误: 缺少必需字段 (version, exportDate, projects)' };
            }

            // 第二层: 结构验证
            for (const project of data.projects) {
                if (!project.id || !project.name || !Array.isArray(project.iterations)) {
                    return { valid: false, error: `项目数据不完整: ${project.name || '未命名项目'}` };
                }

                for (const iteration of project.iterations) {
                    if (!iteration.id || !iteration.name) {
                        return { valid: false, error: `迭代数据不完整: ${project.name}` };
                    }
                }
            }

            // 第三层: 自动修复缺失字段
            const repairedData = JSON.parse(JSON.stringify(data));
            repairedData.projects.forEach(project => {
                if (!project.createdAt) {
                    project.createdAt = new Date().toISOString();
                }

                project.iterations.forEach(iteration => {
                    if (!iteration.createdAt) {
                        iteration.createdAt = project.createdAt;
                    }
                    if (!iteration.completedSteps) {
                        iteration.completedSteps = {};
                    }
                    if (!iteration.inputs) {
                        iteration.inputs = {};
                    }
                    if (!iteration.notes) {
                        iteration.notes = {};
                    }
                    if (!iteration.currentCycle) {
                        iteration.currentCycle = 'init';
                    }
                    if (!iteration.cycleHistory) {
                        iteration.cycleHistory = {};
                    }
                });
            });

            return { valid: true, data: repairedData };
        }

        // 导入确认 (T007, T008)
        async function confirmImport() {
            if (!pendingImportData) {
                showToast('没有待导入的数据', 'error');
                return;
            }

            const mode = document.querySelector('input[name="importMode"]:checked').value;

            if (mode === 'replace') {
                const confirmed = await showConfirm({
                    title: '⚠️ 覆盖模式警告',
                    message: '覆盖模式将清空所有现有数据，确定继续？',
                    confirmText: '确认覆盖',
                    cancelText: '取消',
                    danger: true
                });
                if (!confirmed) {
                    return;
                }
                // T008: 覆盖模式
                projects = pendingImportData.projects;
            } else {
                // T007: 合并模式 - 处理 ID 冲突
                const existingIds = new Set(projects.map(p => p.id));

                pendingImportData.projects.forEach(importProject => {
                    if (existingIds.has(importProject.id)) {
                        // ID 冲突，重新生成 ID
                        importProject.id = 'project_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

                        importProject.iterations.forEach(iteration => {
                            iteration.id = 'iteration_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        });
                    }

                    projects.push(importProject);
                });
            }

            saveProjects();
            closeImportModal();

            // 重新选择第一个项目
            if (projects.length > 0) {
                selectedProjectId = projects[0].id;
                selectedIterationId = projects[0].iterations[0]?.id || null;
                expandedProjects.add(projects[0].id);
            }

            renderProjectTree();
            renderMainContent();

            const count = pendingImportData.projects.length;
            showToast(`✅ 已成功导入 ${count} 个项目 (${mode === 'replace' ? '覆盖' : '合并'}模式)`, 'success');
        }

        // ============ 清空数据功能 (T009) ============
        function openClearDataModal() {
            document.getElementById('clearDataModal').classList.add('active');
            document.getElementById('clearConfirmInput').value = '';
        }

        function closeClearDataModal() {
            document.getElementById('clearDataModal').classList.remove('active');
        }

        function confirmClearData() {
            const input = document.getElementById('clearConfirmInput').value;
            if (input !== '确认删除') {
                showToast('请输入正确的确认文本', 'warning');
                return;
            }

            projects = [];
            saveProjects();
            closeClearDataModal();

            // 重置选择状态
            selectedProjectId = null;
            selectedIterationId = null;
            expandedProjects.clear();

            renderProjectTree();
            renderMainContent();

            showToast('✅ 所有数据已清空', 'success');
        }

        // ============ 项目统计功能 (T010) ============
        function calculateProjectStats(project) {
            const totalSteps = commandSteps.length;
            let totalCompleted = 0;
            let cycleStats = {
                'init': 0,
                'cycle-1': 0,
                'cycle-2': 0,
                'cycle-3': 0,
                'cycle-4': 0,
                'cycle-5': 0,
                'cycle-6': 0
            };
            let phaseStats = {
                'init': { total: 0, completed: 0 },
                'architecture': { total: 0, completed: 0 },
                'development': { total: 0, completed: 0 },
                'iteration': { total: 0, completed: 0 }
            };

            // 统计所有迭代的完成情况
            project.iterations.forEach(iteration => {
                // Defensive check
                const completed = iteration.completedSteps
                    ? Object.values(iteration.completedSteps).filter(v => v).length
                    : 0;
                totalCompleted += completed;

                // 按循环颜色分组统计
                if (iteration.cycleHistory) {
                    Object.keys(iteration.cycleHistory).forEach(stepId => {
                        const cycle = iteration.cycleHistory[stepId];
                        if (cycleStats[cycle] !== undefined) {
                            cycleStats[cycle]++;
                        }
                    });
                }

                // 按阶段统计
                commandSteps.forEach(step => {
                    phaseStats[step.phase].total++;
                    if (iteration.completedSteps && iteration.completedSteps[step.id]) {
                        phaseStats[step.phase].completed++;
                    }
                });
            });

            const totalPossibleSteps = totalSteps * project.iterations.length;
            const completionPercentage = totalPossibleSteps > 0
                ? Math.round((totalCompleted / totalPossibleSteps) * 100)
                : 0;

            return {
                totalIterations: project.iterations.length,
                totalCompleted,
                totalPossibleSteps,
                completionPercentage,
                cycleStats,
                phaseStats,
                remainingSteps: totalPossibleSteps - totalCompleted
            };
        }

        function formatRelativeTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            const diffWeek = Math.floor(diffDay / 7);
            const diffMonth = Math.floor(diffDay / 30);
            const diffYear = Math.floor(diffDay / 365);

            if (diffYear > 0) return `${diffYear} 年前`;
            if (diffMonth > 0) return `${diffMonth} 个月前`;
            if (diffWeek > 0) return `${diffWeek} 周前`;
            if (diffDay > 0) return `${diffDay} 天前`;
            if (diffHour > 0) return `${diffHour} 小时前`;
            if (diffMin > 0) return `${diffMin} 分钟前`;
            return '刚刚';
        }

        function calculateIterationStats(iteration) {
            const totalSteps = commandSteps.length;
            // Defensive check
            const completedSteps = iteration.completedSteps
                ? Object.values(iteration.completedSteps).filter(v => v).length
                : 0;
            const percentage = Math.round((completedSteps / totalSteps) * 100);

            // 按循环统计
            const cycleBreakdown = {};
            if (iteration.cycleHistory) {
                Object.keys(iteration.cycleHistory).forEach(stepId => {
                    const cycle = iteration.cycleHistory[stepId];
                    cycleBreakdown[cycle] = (cycleBreakdown[cycle] || 0) + 1;
                });
            }

            // 按阶段统计
            const phaseBreakdown = {};
            commandSteps.forEach(step => {
                if (!phaseBreakdown[step.phase]) {
                    phaseBreakdown[step.phase] = { completed: 0, total: 0 };
                }
                phaseBreakdown[step.phase].total++;
                if (iteration.completedSteps && iteration.completedSteps[step.id]) {
                    phaseBreakdown[step.phase].completed++;
                }
            });

            return {
                completedSteps,
                totalSteps,
                percentage,
                cycleBreakdown,
                phaseBreakdown,
                remainingSteps: totalSteps - completedSteps
            };
        }

        // ============================================================
        // PRESENTATION LAYER | 表示层
        // ============================================================
        // Handles UI rendering and DOM updates
        // Functions: renderAllViews, renderProjectTree, renderSyncStatus, etc.
        // 处理 UI 渲染和 DOM 更新
        // 函数：renderAllViews, renderProjectTree, renderSyncStatus 等

        // ============ 渲染所有视图 (Hotfix) ============
        function renderAllViews() {
            renderProjectTree();
            renderMainContent();
        }

        // ============ 项目树渲染 (T001, T002) ============
        function renderProjectTree() {
            const treeContainer = document.getElementById('projectTree');

            if (projects.length === 0) {
                treeContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #94a3b8;">
                        <div style="font-size: 3rem; margin-bottom: 16px; opacity: 0.6;">📂</div>
                        <div style="font-size: 0.9rem; line-height: 1.6;">
                            暂无项目<br>
                            点击上方按钮<br>
                            创建新项目
                        </div>
                    </div>
                `;
                return;
            }

            let html = `
                <div class="project-tree-header">
                    <div class="project-tree-title">📁 项目列表</div>
                </div>
            `;

            projects.forEach(project => {
                const isExpanded = expandedProjects.has(project.id);
                const isSelected = selectedProjectId === project.id && !selectedIterationId;

                // T033: Call progressCalculation* functions to get metrics
                const iterationCount = progressCalculationGetIterationCount(project);
                const completionPercentage = progressCalculationGetCompletionPercentage(project);
                const lastUpdated = progressCalculationGetLastUpdated(project);
                const relativeTime = progressCalculationFormatRelativeTime(lastUpdated);

                // T038: Visual indicators for completion status
                const isComplete = completionPercentage === 100;
                const isEmpty = completionPercentage === 0;
                const statusIcon = isComplete ? '✓' : isEmpty ? '○' : '◐';
                const statusClass = isComplete ? 'complete' : isEmpty ? 'empty' : 'in-progress';

                html += `
                    <div class="project-tree-item">
                        <div class="project-tree-node ${isSelected ? 'active' : ''}" onclick="handleProjectClick('${project.id}')">
                            <div class="expand-icon ${isExpanded ? 'expanded' : ''}" onclick="event.stopPropagation(); toggleProject('${project.id}')">
                                ▶
                            </div>
                            <div class="project-tree-content">
                                <div class="project-tree-label" title="${project.name}">${project.name}</div>
                                <!-- T033-T034: Progress information -->
                                <div class="progress-info">
                                    <div class="progress-metrics">
                                        <span class="iteration-count" title="${iterationCount} 个迭代">${iterationCount} 迭代</span>
                                        <span class="completion-badge ${statusClass}" title="完成度: ${completionPercentage}%">${statusIcon} ${completionPercentage}%</span>
                                    </div>
                                    <!-- T034: Progress bar visualization -->
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill ${statusClass}" style="width: ${completionPercentage}%"></div>
                                    </div>
                                    <div class="last-updated" title="最后更新: ${lastUpdated}">更新: ${relativeTime}</div>
                                </div>
                            </div>
                            <!-- T020: Project action buttons -->
                            <div class="project-actions" onclick="event.stopPropagation();">
                                <button class="project-action-btn" onclick="handleEditProject('${project.id}')" title="Edit project">✏️</button>
                                <button class="project-action-btn" onclick="handleDuplicateProject('${project.id}')" title="Duplicate project">📋</button>
                                <button class="project-action-btn project-action-delete" onclick="handleDeleteProject('${project.id}')" title="Delete project">🗑️</button>
                            </div>
                        </div>
                        <div class="project-tree-children ${isExpanded ? 'expanded' : ''}">
                            ${renderIterationTreeNodes(project)}
                        </div>
                    </div>
                `;
            });

            treeContainer.innerHTML = html;
        }

        /**
         * T030: Render step indicators for iteration
         * 为迭代渲染步骤指示器
         * @param {Object} iteration - Iteration object
         * @returns {string} HTML string with step indicators
         */
        function renderStepIndicators(iteration) {
            return commandSteps.map(step => {
                // Get current cycle ID (for cycle-keyed data structure - Feature 004-)
                const currentCycleId = iteration.currentCycle || (iteration.cycles && iteration.cycles[0] && iteration.cycles[0].id);

                // Defensive checks with cycle-keyed structure support
                const isCompleted = iteration.completedSteps && iteration.completedSteps[step.id] &&
                                   (currentCycleId ? iteration.completedSteps[step.id][currentCycleId] === true : iteration.completedSteps[step.id] === true);

                // Check if input exists (support both V1 flat structure and V2 cycle-keyed structure)
                let inputValue = '';
                if (iteration.inputs && iteration.inputs[step.id]) {
                    if (currentCycleId && typeof iteration.inputs[step.id] === 'object') {
                        // V2: cycle-keyed structure
                        inputValue = iteration.inputs[step.id][currentCycleId] || '';
                    } else if (typeof iteration.inputs[step.id] === 'string') {
                        // V1: flat structure (backward compatibility)
                        inputValue = iteration.inputs[step.id];
                    }
                }
                const hasInput = inputValue && inputValue.trim().length > 0;

                // Check if notes exist (support both V1 and V2 structures)
                let notesValue = '';
                if (iteration.notes && iteration.notes[step.id]) {
                    if (currentCycleId && typeof iteration.notes[step.id] === 'object') {
                        // V2: cycle-keyed structure
                        notesValue = iteration.notes[step.id][currentCycleId] || '';
                    } else if (typeof iteration.notes[step.id] === 'string') {
                        // V1: flat structure (backward compatibility)
                        notesValue = iteration.notes[step.id];
                    }
                }
                const hasNotes = notesValue && notesValue.trim().length > 0;

                // Build tooltip content (T033: Plain text for CSS attr tooltips)
                let tooltipContent = `${step.stepNumber}. ${step.title}`;
                if (hasInput) {
                    const inputPreview = inputValue.substring(0, 40);
                    tooltipContent += `\n📝 ${inputPreview}${inputValue.length > 40 ? '...' : ''}`;
                }
                if (hasNotes) {
                    const notesPreview = notesValue.substring(0, 40);
                    tooltipContent += `\n💡 ${notesPreview}${notesValue.length > 40 ? '...' : ''}`;
                }

                return `
                    <span class="step-indicator ${isCompleted ? 'completed' : 'incomplete'}"
                          data-step-id="${step.id}"
                          data-tooltip="${tooltipContent.replace(/"/g, '&quot;')}"
                          title="${step.stepNumber}. ${step.title}${isCompleted ? ' ✓' : ''}">
                        ${isCompleted ? '✓' : '○'}
                    </span>
                `;
            }).join('');
        }

        function renderIterationTreeNodes(project) {
            return project.iterations.map(iteration => {
                // Defensive check: ensure completedSteps exists
                const completedSteps = iteration.completedSteps
                    ? Object.values(iteration.completedSteps).filter(v => v).length
                    : 0;
                const isSelected = selectedProjectId === project.id && selectedIterationId === iteration.id;
                const progressPercent = Math.round((completedSteps / commandSteps.length) * 100);

                // T032: Highlight furthest iteration (most progress)
                const allIterations = project.iterations;
                const maxProgress = Math.max(...allIterations.map(it => {
                    return it.completedSteps
                        ? Object.values(it.completedSteps).filter(v => v).length
                        : 0;
                }));
                const isFurthest = completedSteps === maxProgress && completedSteps > 0;

                return `
                    <div class="iteration-tree-node ${isSelected ? 'active' : ''} ${isFurthest ? 'furthest' : ''}"
                         onclick="selectIteration('${project.id}', '${iteration.id}')">
                        <div class="iteration-tree-label" title="${iteration.name}">${iteration.name}</div>
                        <div class="iteration-tree-progress">
                            <div class="iteration-progress-bar">
                                <div class="iteration-progress-fill" style="width: ${progressPercent}%"></div>
                            </div>
                            <div class="iteration-tree-badge">${completedSteps}/${commandSteps.length}</div>
                        </div>
                        <div class="step-indicators-container">
                            ${renderStepIndicators(iteration)}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleProject(projectId) {
            if (expandedProjects.has(projectId)) {
                expandedProjects.delete(projectId);
            } else {
                expandedProjects.add(projectId);
            }
            renderProjectTree();
        }

        function selectProject(projectId) {
            selectedProjectId = projectId;
            selectedIterationId = null;
            renderProjectTree();
            renderMainContent();
        }

        function selectIteration(projectId, iterationId) {
            selectedProjectId = projectId;
            selectedIterationId = iterationId;
            // 确保项目展开
            expandedProjects.add(projectId);
            renderProjectTree();
            renderMainContent();
        }

        // ============ 主内容区渲染 (T012) ============
        function renderMainContent() {
            const mainContent = document.getElementById('mainContent');

            if (!selectedProjectId) {
                // 显示欢迎页面
                mainContent.innerHTML = renderWelcomePage();
                return;
            }

            const project = projects.find(p => p.id === selectedProjectId);
            if (!project) {
                mainContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">项目不存在</div>';
                return;
            }

            if (!selectedIterationId) {
                // 显示项目概览
                mainContent.innerHTML = renderProjectOverview(project);
            } else {
                // 显示迭代工作流
                const iteration = project.iterations.find(i => i.id === selectedIterationId);
                if (iteration) {
                    mainContent.innerHTML = renderIterationWorkflow(project, iteration);
                    // T039: Initialize auto-resize for input fields after rendering
                    setTimeout(() => initAutoResizeInputs(), 50);
                } else {
                    mainContent.innerHTML = '<div style="padding: 40px; text-align: center; color: #94a3b8;">迭代不存在</div>';
                }
            }
        }

        function renderWelcomePage() {
            const totalProjects = projects.length;
            const totalIterations = projects.reduce((sum, p) => sum + p.iterations.length, 0);
            let totalCompleted = 0;
            let totalPossible = 0;

            projects.forEach(project => {
                project.iterations.forEach(iteration => {
                    // Defensive check
                    const completed = iteration.completedSteps
                        ? Object.values(iteration.completedSteps).filter(v => v).length
                        : 0;
                    totalCompleted += completed;
                    totalPossible += commandSteps.length;
                });
            });

            const overallPercentage = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;

            return `
                <div style="padding: 40px; text-align: center;">
                    <div style="font-size: 4rem; margin-bottom: 24px;">🎯</div>
                    <h2 style="font-size: 1.8rem; margin-bottom: 16px; color: #1e293b;">欢迎使用 Spec Kit 项目管理</h2>
                    <p style="font-size: 1rem; color: #64748b; margin-bottom: 40px; line-height: 1.8;">
                        规范驱动开发（SDD）完整工作流管理工具<br>
                        点击左侧项目查看详情，或创建新项目开始使用
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 800px; margin: 0 auto;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(59, 130, 246, 0.3);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">${totalProjects}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">📁 项目总数</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #10b981, #059669); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(16, 185, 129, 0.3);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">${totalIterations}</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">🔄 迭代总数</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);">
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 8px;">${overallPercentage}%</div>
                            <div style="font-size: 0.9rem; opacity: 0.9;">📊 总体进度</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProjectOverview(project) {
            const stats = calculateProjectStats(project);
            const relativeTime = formatRelativeTime(project.createdAt);

            return `
                <div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; padding-bottom: 16px; border-bottom: 2px solid #e5e7eb;">
                        <div style="flex: 1;">
                            <h2 style="font-size: 1.5rem; font-weight: 700; color: #1e293b; margin-bottom: 8px;">📦 ${project.name}</h2>
                            ${project.description ? `<p style="font-size: 0.95rem; color: #64748b; margin-bottom: 8px; line-height: 1.5;">${project.description}</p>` : ''}
                            <div style="font-size: 0.85rem; color: #64748b;">创建于 ${relativeTime}</div>
                        </div>
                        <div style="display: flex; gap: 12px;">
                            <button class="add-iteration-btn" onclick="openAddIterationModal('${project.id}')">➕ 新建迭代</button>
                            <button class="delete-project-btn" onclick="deleteProject('${project.id}')">删除项目</button>
                        </div>
                    </div>

                    <!-- 项目统计 -->
                    <div style="background: linear-gradient(135deg, #f8fafc, #f1f5f9); border-radius: 12px; padding: 24px; margin-bottom: 24px; border: 2px solid #e5e7eb;">
                        <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 16px;">📊 项目统计</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">总体进度</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #2563eb;">${stats.completionPercentage}%</div>
                                <div style="width: 100%; height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin-top: 8px;">
                                    <div style="width: ${stats.completionPercentage}%; height: 100%; background: linear-gradient(90deg, #2563eb, #10b981); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">已完成步骤</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #10b981;">${stats.totalCompleted} / ${stats.totalPossibleSteps}</div>
                            </div>
                            <div>
                                <div style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">剩余步骤</div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: #f59e0b;">${stats.remainingSteps}</div>
                            </div>
                        </div>
                    </div>

                    <!-- 迭代列表 -->
                    <div>
                        <h3 style="font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 16px;">🔄 迭代列表 (${project.iterations.length} 个)</h3>
                        <div style="display: grid; gap: 12px;">
                            ${project.iterations.map(iteration => renderIterationCard(project, iteration)).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        /**
         * T054: Render Command Library grouped by category
         * T026-T029 [US1]: Modified for multi-column layout support
         * 渲染按分类分组的命令库
         * @param {Array} commandsToRender - Optional filtered command array (defaults to global commands)
         */
        function renderCommandLibrary(commandsToRender = commands) {
            const container = document.getElementById('command-list');
            if (!container) return;

            // T027 [US1]: DATA ACCESS LAYER - Load column preference
            const columnCount = columnLoadPreference();

            // T028 [US1]: BUSINESS LOGIC LAYER - Calculate layout parameters
            const layout = layoutCalculateGrid(columnCount);
            const fonts = layoutCalculateFontSizes(columnCount);

            // T028 [US1]: Apply CSS Grid layout to container
            container.style.display = 'grid';
            container.style.gridTemplateColumns = layout.gridTemplateColumns;
            container.style.gap = layout.gap;
            container.style.width = '100%';

            // T037-T038 [US2] [P]: CSS custom properties for responsive scaling
            container.style.setProperty('--column-count', columnCount);
            container.style.setProperty('--base-font-size', fonts.commandLabelSize + 'px');

            // T029: Preserve existing command rendering logic - Group commands by category
            const grouped = {};
            commandsToRender.forEach(cmd => {
                const category = cmd.category || 'Uncategorized';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(cmd);
            });

            // Empty state (spans full grid width)
            if (commandsToRender.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; color: #94a3b8;">
                        <div style="font-size: 4rem; margin-bottom: 16px; opacity: 0.6;">📋</div>
                        <div style="font-size: 1.1rem; margin-bottom: 8px;">暂无命令</div>
                        <div style="font-size: 0.9rem;">点击"添加命令"开始创建您的命令库</div>
                    </div>
                `;
                return;
            }

            // Render grouped commands with calculated font sizes
            let html = '';
            Object.keys(grouped).sort().forEach(category => {
                // T021-T023: Apply color-coding to categories
                const { color } = colorAssignCategory(category);
                const bgColor = color + '22'; // Add transparency for background

                html += `<div class="command-category" style="grid-column: span 1; border-left-color: ${color};">
                    <div class="command-category-header" style="
                        font-size: ${fonts.categoryHeaderSize}px;
                        background: ${bgColor};
                        color: ${color};
                    ">${category}</div>
                `;

                grouped[category].forEach(cmd => {
                    // T055: Add draggable attributes
                    const truncatedText = cmd.text.length > 100
                        ? cmd.text.substring(0, 100) + '...'
                        : cmd.text;

                    html += `
                        <div class="command-item command-item-dense"
                             style="padding: ${layout.itemPadding};"
                             draggable="true"
                             ondragstart="handleDragStart(event, '${cmd.id}')"
                             ondragover="handleDragOver(event)"
                             ondrop="handleDrop(event, '${cmd.id}')">
                            <div class="command-info">
                                <div class="command-label command-label-dense" style="
                                    font-size: ${fonts.commandLabelSize}px;
                                    line-height: ${fonts.lineHeight};
                                ">${cmd.label}</div>
                                <div class="command-text command-text-dense" style="
                                    font-size: ${fonts.commandTextSize}px;
                                    line-height: ${fonts.lineHeight};
                                " title="${cmd.text}">${truncatedText}</div>
                            </div>
                            <div class="command-actions">
                                <button class="command-action-btn copy-btn"
                                        onclick="handleCopyCommand('${cmd.id}')"
                                        title="复制">
                                    📋
                                </button>
                                <button class="command-action-btn edit-btn"
                                        onclick="handleEditCommand('${cmd.id}')"
                                        title="编辑">
                                    ✏️
                                </button>
                                <button class="command-action-btn delete-btn"
                                        onclick="handleDeleteCommand('${cmd.id}')"
                                        title="删除">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        /**
         * T056: Show toast notification (duplicate removed - using unified version)
         */

        function renderIterationCard(project, iteration) {
            // Defensive check
            const completedSteps = iteration.completedSteps
                ? Object.values(iteration.completedSteps).filter(v => v).length
                : 0;
            const percentage = Math.round((completedSteps / commandSteps.length) * 100);
            const relativeTime = formatRelativeTime(iteration.createdAt);

            return `
                <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 16px; transition: all 0.2s; cursor: pointer;"
                     onclick="selectIteration('${project.id}', '${iteration.id}')"
                     onmouseover="this.style.borderColor='#2563eb'; this.style.boxShadow='0 4px 12px rgba(37, 99, 235, 0.2)'"
                     onmouseout="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div style="flex: 1;">
                            <h4 style="font-size: 1rem; font-weight: 600; color: #1e293b; margin-bottom: 4px;">${iteration.name}</h4>
                            ${iteration.description ? `<p style="font-size: 0.8rem; color: #64748b; margin-bottom: 8px;">${iteration.description}</p>` : ''}
                            <div style="font-size: 0.75rem; color: #94a3b8;">${relativeTime}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 1.2rem; font-weight: 700; color: #2563eb;">${percentage}%</div>
                            <div style="font-size: 0.75rem; color: #64748b;">${completedSteps}/${commandSteps.length}</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                        <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #2563eb, #10b981); transition: width 0.3s;"></div>
                    </div>
                </div>
            `;
        }

        /**
         * T073: Update initializeApp() to call loadProjects(), loadCommands(), renderProjectSidebar() in correct order
         * 更新 initializeApp() 以正确顺序调用 loadProjects()、loadCommands()、renderProjectSidebar()
         */
        // 初始化
        function init() {
            // Load data from storage
            loadProjects();  // Load projects first
            loadCommands();  // Load commands library

            // 默认展开第一个项目并选中第一个迭代
            if (projects.length > 0) {
                selectedProjectId = projects[0].id;
                expandedProjects.add(projects[0].id);
                if (projects[0].iterations.length > 0) {
                    selectedIterationId = projects[0].iterations[0].id;
                }
            }

            // Render UI components
            renderProjectTree();      // Render project sidebar
            renderMainContent();       // Render main content area
            // renderCommandLibrary() will be called automatically when user switches to Commands tab
        }

        // ===========================
        // DATA ACCESS LAYER
        // ===========================

        /**
         * T004: Migrate project schema for backward compatibility
         * 迁移项目数据模型以保持向后兼容
         * @param {Object} project - Project object to migrate
         * @returns {Object} - Migrated project
         */
        function migrateProjectSchema(project) {
            // Add missing 'description' field (FR-002)
            if (!project.description) {
                project.description = '';
            }

            // Add missing 'updatedAt' field (data-model.md requirement)
            if (!project.updatedAt) {
                // Use createdAt as fallback, or current time if createdAt missing
                project.updatedAt = project.createdAt || new Date().toISOString();
            }

            // T013/T017: Add lastModified field for cloud-first sync (Feature 005)
            // 为云优先同步添加 lastModified 字段 (特性 005)
            if (project.lastModified === undefined || project.lastModified === null) {
                project.lastModified = 0; // Epoch 0 = oldest possible timestamp
                project.needsTimestampUpdate = true; // Flag for first save
            }

            // BUGFIX: Migrate iteration schema for backward compatibility
            // Ensure all iterations have required fields to prevent "undefined" errors
            if (project.iterations && Array.isArray(project.iterations)) {
                project.iterations = project.iterations.map(iteration => {
                    // Ensure completedSteps exists
                    if (!iteration.completedSteps || typeof iteration.completedSteps !== 'object') {
                        iteration.completedSteps = {};
                    }

                    // Ensure inputs exists
                    if (!iteration.inputs || typeof iteration.inputs !== 'object') {
                        iteration.inputs = {};
                    }

                    // Ensure notes exists
                    if (!iteration.notes || typeof iteration.notes !== 'object') {
                        iteration.notes = {};
                    }

                    // Ensure currentCycle exists
                    if (!iteration.currentCycle) {
                        iteration.currentCycle = 'init';
                    }

                    // Ensure cycleHistory exists
                    if (!iteration.cycleHistory || typeof iteration.cycleHistory !== 'object') {
                        iteration.cycleHistory = {};
                    }

                    return iteration;
                });
            }

            return project;
        }

        // ============================================================
        // BUSINESS LOGIC LAYER | 业务逻辑层
        // ============================================================
        // Handles timestamp comparison, conflict resolution, and validation
        // Functions: timestampCompare, timestampValidate, conflictResolveProjects, etc.
        // 处理时间戳比较、冲突解决和验证
        // 函数：timestampCompare, timestampValidate, conflictResolveProjects 等

        /**
         * T018: Validate timestamp value
         * 验证时间戳值
         * @param {any} timestamp - Timestamp to validate
         * @returns {{valid: boolean, error?: string}} Validation result
         */
        function timestampValidate(timestamp) {
            // Rule 1: Must be a number
            if (typeof timestamp !== 'number') {
                return { valid: false, error: 'Timestamp must be a number' };
            }

            // Rule 2: Must be positive (epoch 0 is valid, negative is not)
            if (timestamp < 0) {
                return { valid: false, error: 'Timestamp cannot be negative' };
            }

            // Rule 3: Must not be in the future (allow 5-minute clock skew tolerance)
            const now = Date.now();
            const maxAllowed = now + (5 * 60 * 1000); // 5 minutes ahead
            if (timestamp > maxAllowed) {
                return { valid: false, error: 'Timestamp is too far in the future' };
            }

            // Rule 4: Warn if suspiciously old (before year 2020) but don't fail
            const year2020 = new Date('2020-01-01').getTime();
            if (timestamp > 0 && timestamp < year2020) {
                console.warn(`⚠️ Suspicious timestamp: ${new Date(timestamp).toISOString()}`);
            }

            return { valid: true };
        }

        /**
         * T023-T024: Compare two timestamps
         * 比较两个时间戳
         * @param {number|null|undefined} cloudTimestamp - Server timestamp from Firebase
         * @param {number|null|undefined} localTimestamp - Cached timestamp from localStorage
         * @returns {number} -1 if cloud older, 0 if equal, 1 if cloud newer
         */
        function timestampCompare(cloudTimestamp, localTimestamp) {
            // T024: Treat missing timestamp as 0 (oldest possible)
            const cloudTime = (cloudTimestamp === null || cloudTimestamp === undefined) ? 0 : cloudTimestamp;
            const localTime = (localTimestamp === null || localTimestamp === undefined) ? 0 : localTimestamp;

            if (cloudTime > localTime) return 1;  // Cloud is newer
            if (cloudTime < localTime) return -1; // Local is newer
            return 0; // Equal (tie - caller should use cloud)
        }

        /**
         * T026: Merge cloud and local projects using timestamp comparison
         * 使用时间戳比较合并云端和本地项目
         * @param {Array<Project>} cloudProjects - Projects from Firebase
         * @param {Array<Project>} localProjects - Projects from localStorage
         * @returns {Array<Project>} Merged array with newest versions
         */
        function conflictResolveProjects(cloudProjects, localProjects) {
            // Create maps by ID for O(1) lookup
            const cloudMap = {};
            const localMap = {};

            cloudProjects.forEach(p => { cloudMap[p.id] = p; });
            localProjects.forEach(p => { localMap[p.id] = p; });

            // Get all unique project IDs
            const allIds = new Set([...Object.keys(cloudMap), ...Object.keys(localMap)]);

            const merged = [];
            let cloudWins = 0;
            let localWins = 0;

            for (const id of allIds) {
                const cloudProj = cloudMap[id];
                const localProj = localMap[id];

                if (cloudProj && localProj) {
                    // T030: Both exist - compare timestamps with explicit tie-breaking
                    const cmp = timestampCompare(cloudProj.lastModified, localProj.lastModified);
                    if (cmp > 0) {
                        // Cloud is newer
                        merged.push(cloudProj);
                        cloudWins++;
                    } else if (cmp < 0) {
                        // Local is newer (pending sync)
                        merged.push(localProj);
                        localWins++;
                    } else {
                        // T030: Tie (equal timestamps) - use cloud as tie-breaker
                        merged.push(cloudProj);
                        cloudWins++;
                    }
                } else if (cloudProj) {
                    // Only in cloud
                    merged.push(cloudProj);
                } else {
                    // Only local (not yet synced)
                    merged.push(localProj);
                }
            }

            // T031: Log conflict resolution stats
            console.log(`🔄 Conflict resolution: ${cloudWins} cloud wins, ${localWins} local wins`);
            return merged;
        }

        // 加载项目数据
        function loadProjects() {
            const saved = localStorage.getItem('speckit_projects');
            if (saved) {
                projects = JSON.parse(saved);

                // T005: Apply migration for backward compatibility
                projects = projects.map(migrateProjectSchema);

                // 确保每个项目有迭代数据
                projects.forEach(project => {
                    if (!project.iterations) {
                        project.iterations = [{
                            id: 'iteration_' + Date.now(),
                            name: '初始开发',
                            description: '',
                            createdAt: project.createdAt,
                            completedSteps: project.completedSteps || {},
                            inputs: project.inputs || {},
                            notes: {},
                            currentCycle: 'init',
                            cycleHistory: {}
                        }];
                    }
                    // T014: Apply cycle migration for each iteration
                    project.iterations.forEach((iteration, index) => {
                        project.iterations[index] = migrateIterationToCycles(iteration);
                    });
                });
                saveProjects();
            }
        }

        // 保存项目数据
        /**
         * T021: Save projects to both localStorage and Firebase (auto-save trigger)
         * 保存项目到 localStorage 和 Firebase（自动保存触发器）
         */
        async function saveProjects() {
            // T015: Create backup before save (24-hour retention)
            const existing = localStorage.getItem('speckit_projects');
            if (existing) {
                const backup = {
                    data: existing,
                    timestamp: new Date().toISOString(),
                    expiresAt: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
                };
                localStorage.setItem('spec_kit_backup', JSON.stringify(backup));
            }

            // Always save to localStorage first (offline backup)
            localStorage.setItem('speckit_projects', JSON.stringify(projects));
            console.log('💾 Saved to localStorage');

            // If user is authenticated, also save to Firebase
            if (currentUser && firebaseInitialized) {
                try {
                    // Save each project to Firebase
                    for (const project of projects) {
                        await saveProjectToFirebase(currentUser.uid, project.id, project);
                    }
                    console.log('☁️ All projects synced to Firebase');
                } catch (error) {
                    console.error('❌ Failed to sync to Firebase:', error);
                    // Don't show error toast - offline queue will handle it
                }
            }
        }

        /**
         * T006: Save commands to localStorage
         * 保存命令库到 localStorage
         * @returns {void}
         */
        // ========================================
        // T006: Data Access Layer - Category Color Persistence (Feature 006)
        // ========================================
        // Layer: DATA ACCESS
        // Purpose: Persist and retrieve category color mappings from LocalStorage
        // Prohibited: No DOM manipulation, no business logic

        /**
         * T017: Load category color mappings from LocalStorage
         * 从 LocalStorage 加载分类颜色映射
         * @returns {Object} Category-to-color mappings or empty object
         */
        function colorLoadMappings() {
            try {
                const stored = localStorage.getItem('speckit_category_colors');
                return stored ? JSON.parse(stored) : {};
            } catch (error) {
                console.error('Failed to load category colors:', error);
                return {};
            }
        }

        /**
         * T018: Save category color mappings to LocalStorage
         * 保存分类颜色映射到 LocalStorage
         * @param {Object} mappings - Category-to-color mappings
         * @returns {boolean} True if successful, false otherwise
         */
        function colorSaveMappings(mappings) {
            try {
                localStorage.setItem('speckit_category_colors', JSON.stringify(mappings));
                return true;
            } catch (error) {
                console.error('Failed to save category colors:', error);
                return false;
            }
        }

        /**
         * T072: Update saveCommands() to sync to Firebase if user authenticated
         * 更新 saveCommands() 以在用户通过身份验证时同步到 Firebase
         */
        async function saveCommands() {
            // Always save to localStorage first (offline backup)
            try {
                localStorage.setItem('speckit_commands', JSON.stringify(commands));
                console.log('💾 Commands saved to localStorage');
            } catch (error) {
                console.error('❌ Failed to save commands to localStorage:', error);
            }

            // If user is authenticated, also save to Firebase
            if (currentUser && firebaseInitialized) {
                try {
                    const db = getDatabase();
                    const commandsRef = ref(db, `users/${currentUser.uid}/commands`);
                    await set(commandsRef, commands);
                    console.log('☁️ Commands synced to Firebase');
                } catch (error) {
                    console.error('❌ Failed to sync commands to Firebase:', error);
                    // Don't block - localStorage is primary storage
                }
            }
        }

        /**
         * T007: Load commands from localStorage
         * 从 localStorage 加载命令库
         * @returns {void}
         */
        function loadCommands() {
            try {
                const saved = localStorage.getItem('speckit_commands');
                if (saved) {
                    commands = JSON.parse(saved);
                    console.log(`📦 Loaded ${commands.length} commands from localStorage`);
                } else {
                    // T050: Seed defaults on first use
                    commands = commandLibrarySeedDefaults();
                    saveCommands(); // Persist the defaults
                    console.log(`🌱 Seeded ${commands.length} default commands`);
                }
            } catch (error) {
                console.error('❌ Failed to load commands:', error);
                commands = [];
            }
        }

        // ========================================
        // CYCLE MANAGEMENT - DATA ACCESS LAYER
        // ========================================
        // Functions: migrateIterationToCycles()
        // Note: Uses existing saveProjects() and loadProjects()

        /**
         * T013: Migrate iteration from V1 (flat) to V2 (cycle-keyed) data structure
         * 将迭代从 V1（扁平）迁移到 V2（循环键控）数据结构
         * @param {Object} iteration - Iteration object to migrate
         * @returns {Object} Migrated iteration object
         */
        function migrateIterationToCycles(iteration) {
            // Skip if already migrated
            if (iteration.cycles && iteration.cycles.length > 0) {
                return iteration;
            }

            // Create timestamped first cycle
            const migrationDate = new Date().toISOString().split('T')[0];
            const firstCycle = {
                id: `cycle_${Date.now()}`,
                name: `Initial Cycle - Migrated ${migrationDate}`,
                createdAt: iteration.createdAt || new Date().toISOString(),
                order: 1
            };

            // Initialize cycles array
            iteration.cycles = [firstCycle];
            iteration.currentCycle = firstCycle.id;

            // Transform flat inputs to nested structure
            if (iteration.inputs && typeof iteration.inputs === 'object') {
                const oldInputs = { ...iteration.inputs };
                iteration.inputs = {};

                Object.entries(oldInputs).forEach(([stepId, value]) => {
                    iteration.inputs[stepId] = {
                        [firstCycle.id]: value
                    };
                });
            } else {
                iteration.inputs = {};
            }

            // Transform flat notes to nested structure
            if (iteration.notes && typeof iteration.notes === 'object') {
                const oldNotes = { ...iteration.notes };
                iteration.notes = {};

                Object.entries(oldNotes).forEach(([stepId, value]) => {
                    iteration.notes[stepId] = {
                        [firstCycle.id]: value
                    };
                });
            } else {
                iteration.notes = {};
            }

            // Transform flat completedSteps to nested structure
            if (iteration.completedSteps && typeof iteration.completedSteps === 'object') {
                const oldCompleted = { ...iteration.completedSteps };
                iteration.completedSteps = {};

                Object.entries(oldCompleted).forEach(([stepId, completed]) => {
                    iteration.completedSteps[stepId] = {
                        [firstCycle.id]: completed
                    };
                });
            } else {
                iteration.completedSteps = {};
            }

            return iteration;
        }

        // ===========================
        // BUSINESS LOGIC LAYER
        // ===========================

        // --- Validation Module (validate*) ---

        /**
         * T014: Validate project name
         * 验证项目名称
         * @param {string} name - Project name to validate
         * @returns {Object} - {valid: boolean, error?: string}
         */
        function validateProjectName(name) {
            if (!name || typeof name !== 'string') {
                return {valid: false, error: 'Project name is required'};
            }

            const trimmed = name.trim();
            if (trimmed.length === 0) {
                return {valid: false, error: 'Project name cannot be empty'};
            }

            if (trimmed.length > 100) {
                return {valid: false, error: 'Project name cannot exceed 100 characters'};
            }

            return {valid: true};
        }

        /**
         * T015: Validate project description
         * 验证项目描述
         * @param {string} description - Project description to validate
         * @returns {Object} - {valid: boolean, error?: string}
         */
        function validateProjectDescription(description) {
            // Description is optional
            if (!description) {
                return {valid: true};
            }

            if (description.length > 500) {
                return {valid: false, error: 'Description cannot exceed 500 characters'};
            }

            return {valid: true};
        }

        // --- Project CRUD Module (projectCRUD*) ---

        /**
         * T016: Generate unique project name for duplicates
         * 为复制的项目生成唯一名称
         * @param {string} baseName - Original project name
         * @returns {string} - Unique name (e.g., "Project (Copy)", "Project (Copy 2)")
         */
        function projectCRUDGenerateUniqueName(baseName) {
            // Start with "Project Name (Copy)"
            let candidateName = `${baseName} (Copy)`;
            let counter = 2;

            // Check if name exists
            while (projects.some(p => p.name === candidateName)) {
                candidateName = `${baseName} (Copy ${counter})`;
                counter++;
            }

            return candidateName;
        }

        /**
         * T017: Edit project name and description
         * 编辑项目名称和描述
         * @param {string} projectId - Project ID
         * @param {string} newName - New project name
         * @param {string} newDescription - New project description
         * @returns {Object} - {success: boolean, error?: string}
         */
        function projectCRUDEdit(projectId, newName, newDescription) {
            // Validate inputs
            const nameValidation = validateProjectName(newName);
            if (!nameValidation.valid) {
                return {success: false, error: nameValidation.error};
            }

            const descValidation = validateProjectDescription(newDescription);
            if (!descValidation.valid) {
                return {success: false, error: descValidation.error};
            }

            // Find project
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                return {success: false, error: 'Project not found'};
            }

            // Update project
            project.name = newName.trim();
            project.description = newDescription || '';
            project.updatedAt = new Date().toISOString();

            // Save to storage
            saveProjects();

            return {success: true};
        }

        /**
         * T018: Duplicate project with all iterations
         * 复制项目及其所有迭代
         * @param {string} projectId - Source project ID
         * @returns {Object} - {success: boolean, newProjectId?: string, error?: string}
         */
        function projectCRUDDuplicate(projectId) {
            // Find source project
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                return {success: false, error: 'Project not found'};
            }

            // Deep copy using JSON
            const copiedProject = JSON.parse(JSON.stringify(project));

            // Generate new IDs
            copiedProject.id = 'project_' + Date.now();
            copiedProject.name = projectCRUDGenerateUniqueName(project.name);
            copiedProject.createdAt = new Date().toISOString();
            copiedProject.updatedAt = new Date().toISOString();

            // Generate new IDs for all iterations
            copiedProject.iterations = copiedProject.iterations.map((iter, index) => ({
                ...iter,
                id: `${copiedProject.id}_iteration_${Date.now()}_${index}`
            }));

            // Add to projects array
            projects.push(copiedProject);
            saveProjects();

            return {success: true, newProjectId: copiedProject.id};
        }

        /**
         * T019: Delete project after confirmation
         * 删除项目（需确认）
         * @param {string} projectId - Project ID to delete
         * @returns {Object} - {success: boolean, confirmed: boolean, error?: string}
         */
        async function projectCRUDDelete(projectId) {
            // Find project
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                return {success: false, confirmed: false, error: 'Project not found'};
            }

            // Confirm deletion
            const confirmed = confirm(`Are you sure you want to delete "${project.name}"? This action cannot be undone.`);
            if (!confirmed) {
                return {success: false, confirmed: false};
            }

            // Remove project from memory
            projects = projects.filter(p => p.id !== projectId);

            // CRITICAL FIX: Delete from Firebase FIRST, then save remaining projects
            if (currentUser && firebaseInitialized) {
                try {
                    await deleteProjectFromFirebase(currentUser.uid, projectId);
                    console.log(`✅ Project ${projectId} deleted from Firebase`);
                } catch (error) {
                    console.error(`❌ Failed to delete project ${projectId} from Firebase:`, error);
                }
            }

            // Save remaining projects to localStorage and Firebase
            saveProjects();

            return {success: true, confirmed: true};
        }

        // --- Command Library Module (commandLibrary*) ---

        /**
         * T041: Seed default commands for Command Library
         * 为命令库提供默认命令
         * @returns {Array} - Array of default command objects
         */
        function commandLibrarySeedDefaults() {
            return [
                {
                    id: 'cmd_default_1',
                    label: '/speckit.specify - 创建规格说明',
                    text: '/speckit.specify [feature description]',
                    category: 'Spec Kit Workflow',
                    createdAt: new Date().toISOString(),
                    order: 1
                },
                {
                    id: 'cmd_default_2',
                    label: '/speckit.plan - 生成实施计划',
                    text: '/speckit.plan',
                    category: 'Spec Kit Workflow',
                    createdAt: new Date().toISOString(),
                    order: 2
                },
                {
                    id: 'cmd_default_3',
                    label: '/speckit.tasks - 生成任务清单',
                    text: '/speckit.tasks',
                    category: 'Spec Kit Workflow',
                    createdAt: new Date().toISOString(),
                    order: 3
                },
                {
                    id: 'cmd_default_4',
                    label: '/speckit.implement - 执行实施',
                    text: '/speckit.implement',
                    category: 'Spec Kit Workflow',
                    createdAt: new Date().toISOString(),
                    order: 4
                },
                {
                    id: 'cmd_default_5',
                    label: 'Git: 查看状态',
                    text: 'git status',
                    category: 'Git Commands',
                    createdAt: new Date().toISOString(),
                    order: 5
                },
                {
                    id: 'cmd_default_6',
                    label: 'Git: 提交所有更改',
                    text: 'git add . && git commit -m "Update" && git push',
                    category: 'Git Commands',
                    createdAt: new Date().toISOString(),
                    order: 6
                },
                {
                    id: 'cmd_default_7',
                    label: 'Docker: 查看运行容器',
                    text: 'docker ps',
                    category: 'Docker Commands',
                    createdAt: new Date().toISOString(),
                    order: 7
                },
                {
                    id: 'cmd_default_8',
                    label: 'Docker: 停止所有容器',
                    text: 'docker stop $(docker ps -aq)',
                    category: 'Docker Commands',
                    createdAt: new Date().toISOString(),
                    order: 8
                },
                {
                    id: 'cmd_default_9',
                    label: 'NPM: 安装依赖',
                    text: 'npm install',
                    category: 'NPM Commands',
                    createdAt: new Date().toISOString(),
                    order: 9
                },
                {
                    id: 'cmd_default_10',
                    label: 'NPM: 运行开发服务器',
                    text: 'npm run dev',
                    category: 'NPM Commands',
                    createdAt: new Date().toISOString(),
                    order: 10
                }
            ];
        }

        /**
         * T042: Validate command label
         * 验证命令标签
         * @param {string} label - Command label to validate
         * @returns {Object} - {valid: boolean, error?: string}
         */
        function validateCommandLabel(label) {
            if (!label || typeof label !== 'string') {
                return {valid: false, error: 'Command label is required'};
            }

            const trimmed = label.trim();
            if (trimmed.length === 0) {
                return {valid: false, error: 'Command label cannot be empty'};
            }

            if (trimmed.length > 100) {
                return {valid: false, error: 'Command label cannot exceed 100 characters'};
            }

            return {valid: true};
        }

        /**
         * T043: Validate command text
         * 验证命令文本
         * @param {string} text - Command text to validate
         * @returns {Object} - {valid: boolean, error?: string}
         */
        function validateCommandText(text) {
            if (!text || typeof text !== 'string') {
                return {valid: false, error: 'Command text is required'};
            }

            const trimmed = text.trim();
            if (trimmed.length === 0) {
                return {valid: false, error: 'Command text cannot be empty'};
            }

            if (trimmed.length > 1000) {
                return {valid: false, error: 'Command text cannot exceed 1000 characters'};
            }

            return {valid: true};
        }

        /**
         * T044: Add new command to library
         * 添加新命令到库
         * @param {string} label - Command label
         * @param {string} text - Command text
         * @param {string} category - Optional category
         * @returns {Object} - {success: boolean, error?: string, commandId?: string}
         */
        function commandLibraryAdd(label, text, category = '') {
            // Validate inputs
            const labelValidation = validateCommandLabel(label);
            if (!labelValidation.valid) {
                return {success: false, error: labelValidation.error};
            }

            const textValidation = validateCommandText(text);
            if (!textValidation.valid) {
                return {success: false, error: textValidation.error};
            }

            // Create new command
            const newCommand = {
                id: 'cmd_' + Date.now(),
                label: label.trim(),
                text: text.trim(),
                category: category.trim(),
                createdAt: new Date().toISOString(),
                order: commands.length + 1
            };

            // Add to commands array
            commands.push(newCommand);
            saveCommands();

            return {success: true, commandId: newCommand.id};
        }

        /**
         * T045: Edit existing command
         * 编辑现有命令
         * @param {string} commandId - Command ID to edit
         * @param {string} newLabel - New label
         * @param {string} newText - New command text
         * @param {string} newCategory - New category
         * @returns {Object} - {success: boolean, error?: string}
         */
        function commandLibraryEdit(commandId, newLabel, newText, newCategory = '') {
            // Find command
            const command = commands.find(c => c.id === commandId);
            if (!command) {
                return {success: false, error: 'Command not found'};
            }

            // Validate inputs
            const labelValidation = validateCommandLabel(newLabel);
            if (!labelValidation.valid) {
                return {success: false, error: labelValidation.error};
            }

            const textValidation = validateCommandText(newText);
            if (!textValidation.valid) {
                return {success: false, error: textValidation.error};
            }

            // Update command
            command.label = newLabel.trim();
            command.text = newText.trim();
            command.category = newCategory.trim();
            saveCommands();

            return {success: true};
        }

        /**
         * T046: Delete command from library
         * 从库中删除命令
         * @param {string} commandId - Command ID to delete
         * @returns {Object} - {success: boolean, error?: string}
         */
        function commandLibraryDelete(commandId) {
            // Find command
            const index = commands.findIndex(c => c.id === commandId);
            if (index === -1) {
                return {success: false, error: 'Command not found'};
            }

            // Remove command
            commands.splice(index, 1);
            saveCommands();

            return {success: true};
        }

        /**
         * T047: Copy command text to clipboard
         * 复制命令文本到剪贴板
         * @param {string} commandText - Command text to copy
         * @returns {Promise<Object>} - {success: boolean, error?: string}
         */
        async function commandLibraryCopy(commandText) {
            try {
                // Try Clipboard API first
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(commandText);
                    return {success: true};
                }

                // Fallback: use textarea method
                const textarea = document.createElement('textarea');
                textarea.value = commandText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();

                const success = document.execCommand('copy');
                document.body.removeChild(textarea);

                if (success) {
                    return {success: true};
                } else {
                    return {success: false, error: 'Failed to copy to clipboard'};
                }
            } catch (error) {
                return {success: false, error: error.message};
            }
        }

        /**
         * T048: Search/filter commands
         * 搜索/过滤命令
         * @param {string} searchTerm - Search term
         * @returns {Array} - Filtered command array
         */
        function commandLibrarySearch(searchTerm) {
            if (!searchTerm || searchTerm.trim().length === 0) {
                return commands;
            }

            const term = searchTerm.toLowerCase().trim();
            return commands.filter(cmd => {
                return cmd.label.toLowerCase().includes(term) ||
                       cmd.text.toLowerCase().includes(term) ||
                       cmd.category.toLowerCase().includes(term);
            });
        }

        /**
         * T049: Reorder commands via drag-drop
         * 通过拖放重新排序命令
         * @param {string} sourceCommandId - Source command ID
         * @param {string} targetCommandId - Target command ID
         * @returns {Object} - {success: boolean, error?: string}
         */
        function commandLibraryReorder(sourceCommandId, targetCommandId) {
            // Find commands
            const sourceIndex = commands.findIndex(c => c.id === sourceCommandId);
            const targetIndex = commands.findIndex(c => c.id === targetCommandId);

            if (sourceIndex === -1 || targetIndex === -1) {
                return {success: false, error: 'Command not found'};
            }

            // Remove source command
            const [sourceCommand] = commands.splice(sourceIndex, 1);

            // Insert at target position
            const newTargetIndex = sourceIndex < targetIndex ? targetIndex - 1 : targetIndex;
            commands.splice(newTargetIndex, 0, sourceCommand);

            // Update order values
            commands.forEach((cmd, index) => {
                cmd.order = index + 1;
            });

            saveCommands();
            return {success: true};
        }

        // ========================================
        // T003-T005: Module Boundaries (Feature 006 - Constitution Principle VI)
        // ========================================

        // --- Color Management Module (color*) ---
        /**
         * MODULE: Color Management (color*)
         * PURPOSE: Manage category color assignments, palette selection, and color persistence
         * LAYER: Business Logic + Data Access
         * DEPENDENCIES: LocalStorage API only
         *
         * Functions:
         * - colorLoadMappings(): Load category-to-color mappings from LocalStorage
         * - colorSaveMappings(mappings): Save category-to-color mappings to LocalStorage
         * - colorAssignCategory(categoryName): Get or assign color for a category
         * - colorGetPalette(): Retrieve the full color palette with accessibility data
         */

        // T019: Business Logic - Get color palette
        /**
         * Get the full color palette with accessibility metadata
         * @returns {Array<ColorInfo>} Array of color info objects
         */
        function colorGetPalette() {
            return COLOR_PALETTE;
        }

        // T020: Business Logic - Assign category color
        /**
         * Get existing color for a category or assign a new one from the palette
         * @param {string} categoryName - Category name to assign color to
         * @returns {Object} { color: string, isNew: boolean, paletteIndex: number }
         */
        function colorAssignCategory(categoryName) {
            // Normalize category name
            const key = categoryName.toLowerCase().trim();

            // Load existing mappings
            const mappings = colorLoadMappings();

            // Check if already assigned
            if (mappings[key]) {
                return {
                    color: mappings[key].color,
                    isNew: false,
                    paletteIndex: mappings[key].paletteIndex
                };
            }

            // Assign new color using rotation algorithm
            const existingCount = Object.keys(mappings).length;
            const paletteIndex = existingCount % COLOR_PALETTE.length;
            const assignment = {
                color: COLOR_PALETTE[paletteIndex].color,
                assignedAt: Date.now(),
                paletteIndex: paletteIndex
            };

            // Save and return
            mappings[key] = assignment;
            const saved = colorSaveMappings(mappings);

            if (!saved) {
                console.warn('Failed to persist color assignment for category:', categoryName);
            }

            return {
                color: assignment.color,
                isNew: true,
                paletteIndex: paletteIndex
            };
        }

        // --- Layout Density Module (layout*) ---
        /**
         * MODULE: Layout Density (layout*)
         * PURPOSE: Calculate optimal spacing, font sizes, and layout parameters for density
         * LAYER: Business Logic
         * DEPENDENCIES: None (pure calculation functions)
         *
         * Functions:
         * - layoutCalculateDensity(viewportHeight, commandCount): Calculate layout parameters
         * - layoutGetResponsiveParams(screenWidth): Get responsive layout settings
         */

        // T031: Calculate layout density parameters
        /**
         * Calculate optimal layout parameters for information density
         * @param {number} viewportHeight - Viewport height in pixels
         * @param {number} commandCount - Number of commands to display
         * @returns {Object} Layout parameters with itemHeight, padding, fonts, etc.
         */
        function layoutCalculateDensity(viewportHeight, commandCount) {
            const baseParams = {
                itemPadding: 12,
                itemMargin: 10,
                labelFontSize: 14.4,
                textFontSize: 12.8,
                lineHeight: 1.3
            };

            // Calculate total item height
            const itemHeight = (baseParams.itemPadding * 2) +
                               (baseParams.labelFontSize * baseParams.lineHeight) +
                               (baseParams.textFontSize * baseParams.lineHeight) +
                               baseParams.itemMargin;

            // Calculate how many items fit in viewport
            const itemsPerView = Math.floor(viewportHeight / itemHeight);

            return {
                ...baseParams,
                itemHeight: itemHeight,
                itemsPerView: itemsPerView
            };
        }

        // T032: Get responsive layout parameters
        /**
         * Get responsive layout parameters based on screen width
         * @param {number} screenWidth - Screen width in pixels
         * @returns {Object} Responsive layout settings
         */
        function layoutGetResponsiveParams(screenWidth) {
            if (screenWidth < 640) {
                return {
                    breakpoint: "mobile",
                    fontSize: "0.85rem",
                    minFontPx: 14,
                    padding: "10px"
                };
            } else if (screenWidth < 1024) {
                return {
                    breakpoint: "tablet",
                    fontSize: "0.88rem",
                    minFontPx: 14,
                    padding: "11px"
                };
            } else {
                return {
                    breakpoint: "desktop",
                    fontSize: "0.9rem",
                    minFontPx: 14,
                    padding: "12px"
                };
            }
        }

        // --- Presentation Module (render*) ---
        /**
         * MODULE: Presentation (render*)
         * PURPOSE: Render command library with color-coded categories and optimized layout
         * LAYER: Presentation
         * DEPENDENCIES: Color Module (colorAssignCategory), Layout Module (layoutCalculateDensity)
         *
         * Functions:
         * - renderCommandLibrary(commandsToRender): Render with enhancements (MODIFIED in Phase 4-5)
         */

        // (renderCommandLibrary modifications will be added in Phase 4-5)

        // --- Progress Calculation Module (progressCalculation*) ---

        /**
         * T028: Check if iteration is complete
         * 检查迭代是否完成
         * @param {Object} iteration - Iteration object to check
         * @returns {boolean} - True if all required steps are completed
         */
        function progressCalculationIsIterationComplete(iteration) {
            // Defensive check
            if (!iteration || !iteration.completedSteps) {
                return false;
            }

            // Check if all command steps are completed
            const completedCount = Object.values(iteration.completedSteps).filter(v => v === true).length;
            return completedCount === commandSteps.length;
        }

        /**
         * T029: Get iteration count for a project
         * 获取项目的迭代数量
         * @param {Object} project - Project object
         * @returns {number} - Number of iterations
         */
        function progressCalculationGetIterationCount(project) {
            // Defensive check
            if (!project || !Array.isArray(project.iterations)) {
                return 0;
            }

            return project.iterations.length;
        }

        /**
         * T030: Calculate completion percentage for a project
         * 计算项目的完成百分比
         * @param {Object} project - Project object
         * @returns {number} - Completion percentage (0-100), rounded to nearest integer
         */
        function progressCalculationGetCompletionPercentage(project) {
            // Defensive check
            if (!project || !Array.isArray(project.iterations) || project.iterations.length === 0) {
                return 0; // Division-by-zero handling
            }

            // Count completed iterations
            let completedIterations = 0;
            project.iterations.forEach(iteration => {
                if (progressCalculationIsIterationComplete(iteration)) {
                    completedIterations++;
                }
            });

            // Calculate percentage
            const percentage = (completedIterations / project.iterations.length) * 100;
            return Math.round(percentage);
        }

        /**
         * T031: Get last updated timestamp for a project
         * 获取项目的最后更新时间戳
         * @param {Object} project - Project object
         * @returns {string} - ISO8601 timestamp
         */
        function progressCalculationGetLastUpdated(project) {
            // Defensive check
            if (!project) {
                return new Date().toISOString();
            }

            // Return updatedAt if available, otherwise createdAt, otherwise current time
            return project.updatedAt || project.createdAt || new Date().toISOString();
        }

        /**
         * T032: Format relative time with 30-day threshold
         * 格式化相对时间（30天阈值）
         * @param {string} isoTimestamp - ISO8601 timestamp string
         * @returns {string} - Formatted relative time or absolute date
         */
        function progressCalculationFormatRelativeTime(isoTimestamp) {
            // Defensive check
            if (!isoTimestamp) {
                return 'Unknown';
            }

            try {
                const date = new Date(isoTimestamp);
                const now = new Date();
                const diffMs = now - date;
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

                // If older than 30 days, show absolute date
                if (diffDays > 30) {
                    return date.toLocaleDateString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit'
                    });
                }

                // Otherwise show relative time
                if (diffDays > 0) {
                    return `${diffDays} 天前`;
                }

                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                if (diffHours > 0) {
                    return `${diffHours} 小时前`;
                }

                const diffMinutes = Math.floor(diffMs / (1000 * 60));
                if (diffMinutes > 0) {
                    return `${diffMinutes} 分钟前`;
                }

                return '刚刚';
            } catch (error) {
                console.error('Error formatting relative time:', error);
                return 'Unknown';
            }
        }

        // ========================================
        // CYCLE MANAGEMENT - BUSINESS LOGIC LAYER
        // ========================================
        // Functions: cycleManagementAdd(), cycleManagementRename(),
        //            cycleManagementDelete(), cycleManagementSwitch(),
        //            validateCycleName(), getAdjacentCycle(), removeAllCycleData()

        /**
         * T018: Validate cycle name input
         * 验证循环名称输入
         * @param {string} name - Cycle name to validate
         * @returns {{valid: boolean, errors: string[]}} Validation result
         */
        function validateCycleName(name) {
            const errors = [];

            const trimmedName = (name || '').trim();

            if (!trimmedName) {
                errors.push('Cycle name cannot be empty');
            }

            if (trimmedName.length > 200) {
                errors.push('Cycle name cannot exceed 200 characters');
            }

            return {
                valid: errors.length === 0,
                errors
            };
        }

        /**
         * T019: Add a new cycle to an iteration
         * 为迭代添加新循环
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleName - Optional custom cycle name
         * @returns {Object|null} New cycle object or null if failed
         */
        function cycleManagementAdd(projectId, iterationId, cycleName) {
            // Find project and iteration
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('Project not found');
                return null;
            }

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) {
                alert('Iteration not found');
                return null;
            }

            // Generate cycle name
            const trimmedName = (cycleName || '').trim();
            const defaultName = `Cycle ${iteration.cycles.length + 1}`;
            const finalName = trimmedName || defaultName;

            // Validate name
            const validation = validateCycleName(finalName);
            if (!validation.valid) {
                alert(validation.errors[0]);
                return null;
            }

            // Create new cycle
            const newCycle = {
                id: `cycle_${Date.now()}`,
                name: finalName,
                createdAt: new Date().toISOString(),
                order: Math.max(...iteration.cycles.map(c => c.order), 0) + 1
            };

            // Add to cycles array
            iteration.cycles.push(newCycle);
            iteration.currentCycle = newCycle.id;

            // Initialize empty data for all workflow steps
            commandSteps.forEach(step => {
                const stepId = step.id;

                // Ensure nested structure exists
                if (!iteration.inputs[stepId]) iteration.inputs[stepId] = {};
                if (!iteration.notes[stepId]) iteration.notes[stepId] = {};
                if (!iteration.completedSteps[stepId]) iteration.completedSteps[stepId] = {};

                // Initialize empty data for this cycle
                iteration.inputs[stepId][newCycle.id] = '';
                iteration.notes[stepId][newCycle.id] = '';
                iteration.completedSteps[stepId][newCycle.id] = false;
            });

            // Save changes
            saveProjects();

            return newCycle;
        }

        /**
         * T037: Get adjacent cycle for auto-switch after deletion
         * 获取相邻循环用于删除后自动切换
         * @param {Object} iteration - Iteration object
         * @param {string} deletedCycleId - ID of cycle being deleted
         * @returns {Object} Adjacent cycle object
         */
        function getAdjacentCycle(iteration, deletedCycleId) {
            // Sort cycles by order
            const sortedCycles = iteration.cycles.slice().sort((a, b) => a.order - b.order);

            // Find index of deleted cycle
            const deletedIndex = sortedCycles.findIndex(c => c.id === deletedCycleId);

            if (deletedIndex === -1) {
                // Cycle not found, return first cycle as fallback
                return sortedCycles[0];
            }

            // Try previous cycle first
            if (deletedIndex > 0) {
                return sortedCycles[deletedIndex - 1];
            }

            // Otherwise return next cycle
            if (deletedIndex < sortedCycles.length - 1) {
                return sortedCycles[deletedIndex + 1];
            }

            // Fallback to first cycle (shouldn't happen if validation works)
            return sortedCycles[0];
        }

        /**
         * T038: Remove all cycle data from iteration
         * 从迭代中删除所有循环数据
         * @param {Object} iteration - Iteration object
         * @param {string} cycleId - Cycle ID to remove data for
         */
        function removeAllCycleData(iteration, cycleId) {
            // Remove from inputs
            Object.keys(iteration.inputs || {}).forEach(stepId => {
                if (iteration.inputs[stepId] && iteration.inputs[stepId][cycleId] !== undefined) {
                    delete iteration.inputs[stepId][cycleId];
                }
            });

            // Remove from notes
            Object.keys(iteration.notes || {}).forEach(stepId => {
                if (iteration.notes[stepId] && iteration.notes[stepId][cycleId] !== undefined) {
                    delete iteration.notes[stepId][cycleId];
                }
            });

            // Remove from completedSteps
            Object.keys(iteration.completedSteps || {}).forEach(stepId => {
                if (iteration.completedSteps[stepId] && iteration.completedSteps[stepId][cycleId] !== undefined) {
                    delete iteration.completedSteps[stepId][cycleId];
                }
            });
        }

        /**
         * T031: Rename an existing cycle
         * 重命名现有循环
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - Cycle ID to rename
         * @param {string} newName - New name for the cycle
         * @returns {boolean} True if successful, false otherwise
         */
        function cycleManagementRename(projectId, iterationId, cycleId, newName) {
            // Find project and iteration
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('Project not found');
                return false;
            }

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) {
                alert('Iteration not found');
                return false;
            }

            // Find cycle
            const cycle = iteration.cycles.find(c => c.id === cycleId);
            if (!cycle) {
                alert('Cycle not found');
                return false;
            }

            // Validate new name
            const trimmedName = newName.trim();
            const validation = validateCycleName(trimmedName);
            if (!validation.valid) {
                alert(validation.errors[0]);
                return false;
            }

            // Update cycle name
            cycle.name = trimmedName;

            // Save changes
            saveProjects();

            return true;
        }

        /**
         * T039: Delete a cycle with confirmation and data cleanup
         * 删除循环（需确认）并清理数据
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - Cycle ID to delete
         * @returns {boolean} True if successful, false otherwise
         */
        async function cycleManagementDelete(projectId, iterationId, cycleId) {
            // Find project and iteration
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('Project not found');
                return false;
            }

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) {
                alert('Iteration not found');
                return false;
            }

            // Check minimum cycle constraint
            if (iteration.cycles.length === 1) {
                alert('Cannot delete the last cycle. Each iteration must have at least one cycle.');
                return false;
            }

            // Find cycle to get name for confirmation
            const cycle = iteration.cycles.find(c => c.id === cycleId);
            if (!cycle) {
                alert('Cycle not found');
                return false;
            }

            // Show confirmation dialog with data loss warning
            const confirmed = await showConfirm({
                title: `⚠️ 删除循环: "${cycle.name}"`,
                message: '这将永久删除该循环的所有数据（输入、笔记、完成状态）。此操作无法撤销。',
                confirmText: '确认删除',
                cancelText: '取消',
                danger: true
            });

            if (!confirmed) {
                return false;
            }

            // Determine if need auto-switch
            const deletingCurrentCycle = iteration.currentCycle === cycleId;
            if (deletingCurrentCycle) {
                // Get adjacent cycle for auto-switch
                const adjacentCycle = getAdjacentCycle(iteration, cycleId);
                iteration.currentCycle = adjacentCycle.id;
            }

            // Remove cycle from array
            iteration.cycles = iteration.cycles.filter(c => c.id !== cycleId);

            // Remove all cycle data
            removeAllCycleData(iteration, cycleId);

            // Save changes
            saveProjects();

            return true;
        }

        /**
         * T047: Switch to a different cycle
         * 切换到不同的循环
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - Cycle ID to switch to
         * @returns {boolean} True if successful, false otherwise
         */
        function cycleManagementSwitch(projectId, iterationId, cycleId) {
            // Find project and iteration
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                alert('Project not found');
                return false;
            }

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) {
                alert('Iteration not found');
                return false;
            }

            // Validate cycle exists
            const cycle = iteration.cycles.find(c => c.id === cycleId);
            if (!cycle) {
                alert('Cycle not found');
                return false;
            }

            // Update current cycle
            iteration.currentCycle = cycleId;

            // Save changes
            saveProjects();

            return true;
        }

        // ========================================
        // CYCLE MANAGEMENT - PRESENTATION LAYER
        // ========================================
        // Functions: renderCycleSelector(), truncateCycleName(), escapeHtml()
        // Updates: renderIterationWorkflow() extended for cycle support

        /**
         * T022: Escape HTML special characters to prevent XSS
         * 转义 HTML 特殊字符以防止 XSS
         * @param {string} text - Text to escape
         * @returns {string} Escaped text
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        /**
         * T021: Truncate cycle name with ellipsis if too long
         * 截断过长的循环名称并添加省略号
         * @param {string} name - Cycle name to truncate
         * @param {number} maxLength - Maximum length before truncation
         * @returns {string} Truncated name
         */
        function truncateCycleName(name, maxLength) {
            if (!name || name.length <= maxLength) {
                return name;
            }
            return name.substring(0, maxLength - 3) + '...';
        }

        /**
         * T020: Render cycle selector dropdown and action buttons
         * 渲染循环选择器下拉框和操作按钮
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @returns {string} HTML string for cycle selector
         */
        function renderCycleSelector(projectId, iterationId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return '';

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return '';

            // Sort cycles by order
            const cycles = (iteration.cycles || []).sort((a, b) => a.order - b.order);
            if (cycles.length === 0) return '';

            const cycleOptions = cycles.map(cycle => {
                const isSelected = cycle.id === iteration.currentCycle;
                const displayName = escapeHtml(truncateCycleName(cycle.name, 50));
                const fullName = escapeHtml(cycle.name);
                return `<option value="${cycle.id}" ${isSelected ? 'selected' : ''} title="${fullName}">${displayName}</option>`;
            }).join('');

            return `
                <div class="cycle-selector" style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 10px;">
                    <label style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">Cycle:</label>
                    <select id="cycleSelect"
                            onchange="handleCycleSwitch('${projectId}', '${iterationId}', this.value)"
                            style="flex: 1; padding: 8px 12px; border: 2px solid #e5e7eb; border-radius: 6px; font-size: 0.9rem; background: white; cursor: pointer;">
                        ${cycleOptions}
                    </select>
                    <button onclick="handleAddCycle('${projectId}', '${iterationId}')"
                            title="Add Cycle"
                            style="padding: 8px 12px; border: none; border-radius: 6px; background: #2563eb; color: white; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                        ➕
                    </button>
                    <button onclick="handleRenameCycle('${projectId}', '${iterationId}', '${iteration.currentCycle}')"
                            title="Rename Cycle"
                            style="padding: 8px 12px; border: none; border-radius: 6px; background: #6b7280; color: white; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                        ✏️
                    </button>
                    <button onclick="handleDeleteCycle('${projectId}', '${iterationId}', '${iteration.currentCycle}')"
                            title="Delete Cycle"
                            style="padding: 8px 12px; border: none; border-radius: 6px; background: #dc2626; color: white; cursor: pointer; font-size: 1rem; transition: all 0.2s;">
                        🗑️
                    </button>
                </div>
            `;
        }

        // 渲染迭代工作流
        function renderIterationWorkflow(project, iteration) {
            const stats = calculateIterationStats(iteration);

            // 循环统计标签
            const cycleLabels = {
                'init': '初始化',
                'cycle-1': '循环1',
                'cycle-2': '循环2',
                'cycle-3': '循环3',
                'cycle-4': '循环4',
                'cycle-5': '循环5',
                'cycle-6': '循环6'
            };

            const cycleColors = {
                'init': '#6b7280',
                'cycle-1': '#3b82f6',
                'cycle-2': '#ec4899',
                'cycle-3': '#f59e0b',
                'cycle-4': '#6366f1',
                'cycle-5': '#14b8a6',
                'cycle-6': '#f43f5e'
            };

            // 生成循环统计 HTML
            const cycleStatsHtml = Object.keys(stats.cycleBreakdown)
                .filter(cycle => stats.cycleBreakdown[cycle] > 0)
                .map(cycle => `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(255,255,255,0.8); border-radius: 6px; border: 2px solid ${cycleColors[cycle]};">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${cycleColors[cycle]};"></div>
                        <span style="font-size: 0.75rem; color: #1e293b; font-weight: 600;">${cycleLabels[cycle]}: ${stats.cycleBreakdown[cycle]} 步</span>
                    </div>
                `).join('');

            // 生成阶段统计 HTML
            const phaseLabels = {
                'init': '🎯 初始化',
                'architecture': '🏛️ 架构约束',
                'development': '⚡ 功能开发',
                'iteration': '🔄 迭代优化'
            };

            const phaseStatsHtml = Object.keys(stats.phaseBreakdown)
                .map(phase => {
                    const { completed, total } = stats.phaseBreakdown[phase];
                    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                    return `
                        <div style="margin-bottom: 10px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span style="font-size: 0.75rem; color: #1e293b; font-weight: 600;">${phaseLabels[phase]}</span>
                                <span style="font-size: 0.7rem; color: #64748b;">${completed}/${total}</span>
                            </div>
                            <div style="width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${percentage}%; height: 100%; background: linear-gradient(90deg, #2563eb, #10b981); transition: width 0.3s;"></div>
                            </div>
                        </div>
                    `;
                }).join('');

            // 统计信息面板
            const statsPanel = `
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 16px rgba(0,0,0,0.1); border: 2px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h3 style="font-size: 1rem; font-weight: 700; color: #1e293b;">📈 迭代统计</h3>
                        <div style="font-size: 1.1rem; font-weight: 700; color: #2563eb;">${stats.percentage}% 完成</div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- 循环分布 -->
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 10px;">🎨 循环分布</div>
                            ${cycleStatsHtml || '<div style="font-size: 0.75rem; color: #94a3b8;">暂无已完成步骤</div>'}
                        </div>

                        <!-- 阶段进度 -->
                        <div>
                            <div style="font-size: 0.85rem; font-weight: 600; color: #64748b; margin-bottom: 10px;">📊 阶段进度</div>
                            ${phaseStatsHtml}
                        </div>
                    </div>

                    <div style="margin-top: 16px; padding-top: 16px; border-top: 2px solid #e5e7eb; display: flex; justify-content: space-between; font-size: 0.8rem;">
                        <span style="color: #64748b;">✅ 已完成: <strong style="color: #10b981;">${stats.completedSteps}</strong></span>
                        <span style="color: #64748b;">📝 总步骤: <strong style="color: #1e293b;">${stats.totalSteps}</strong></span>
                        <span style="color: #64748b;">⏳ 剩余: <strong style="color: #f59e0b;">${stats.remainingSteps}</strong></span>
                    </div>
                </div>
            `;

            // T023: Render cycle selector using the new function
            const cycleSelector = renderCycleSelector(project.id, iteration.id);

            let html = statsPanel + cycleSelector;
            let currentPhase = '';
            
            commandSteps.forEach(step => {
                if (step.phase !== currentPhase) {
                    if (currentPhase !== '') {
                        html += '</div>';
                    }
                    currentPhase = step.phase;
                    html += `
                        <div class="phase-header">
                            <h2><span class="phase-icon">${phases[step.phase].icon}</span> ${phases[step.phase].title}</h2>
                        </div>
                        <div class="workflow">
                    `;
                }

                // T024: Read cycle-specific data for current cycle
                const currentCycleId = iteration.currentCycle;
                const isCompleted = iteration.completedSteps[step.id]?.[currentCycleId] || false;
                const savedInput = iteration.inputs[step.id]?.[currentCycleId] || '';
                const savedNotes = iteration.notes[step.id]?.[currentCycleId] || '';

                // 获取该步骤完成时的循环颜色
                const stepCycle = iteration.cycleHistory[step.id] || currentCycleId;
                
                // 特殊处理初始化阶段
                let cycleClass = '';
                if (isCompleted) {
                    if (step.phase === 'init') {
                        cycleClass = 'init-phase';
                    } else {
                        cycleClass = stepCycle;
                    }
                }
                
                html += `
                    <div class="command-card ${isCompleted ? 'completed' : ''} ${cycleClass}" data-project="${project.id}" data-iteration="${iteration.id}" data-step="${step.id}">
                        ${isCompleted ? '<div class="completed-badge">✓ 已完成</div>' : ''}
                        <span class="step-number">${step.stepNumber}</span>
                        <div class="command-title">${step.title}</div>
                        <div class="command-subtitle">${step.subtitle}</div>
                        <div class="command-desc">${step.desc}</div>
                        <div class="command-box">${step.command}</div>
                        ${step.hasInput ? `
                            <textarea class="command-input"
                                      placeholder="${step.inputPlaceholder}"
                                      data-command="${step.command}"
                                      rows="1"
                                      oninput="autoResizeInput(this)"
                                      onchange="saveInput('${project.id}', '${iteration.id}', '${step.id}', this.value)">${savedInput}</textarea>
                        ` : ''}
                        ${step.hasNotes ? `
                            <textarea class="command-notes" 
                                      placeholder="记录错误信息、问题或笔记..."
                                      onchange="saveNotes('${project.id}', '${iteration.id}', '${step.id}', this.value)">${savedNotes}</textarea>
                        ` : ''}
                        <button class="copy-btn" onclick="copyCommandWithTracking('${project.id}', '${iteration.id}', '${step.id}', ${step.hasInput})">
                            📋 复制命令
                        </button>
                        ${step.note ? `<div class="note">${step.note}</div>` : ''}
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ========================================
        // CYCLE MANAGEMENT - EVENT HANDLER LAYER
        // ========================================
        // Functions: handleAddCycle(), handleRenameCycle(),
        //            handleDeleteCycle(), handleCycleSwitch()

        /**
         * T025: Handle Add Cycle button click
         * 处理添加循环按钮点击
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         */
        function handleAddCycle(projectId, iterationId) {
            // Prompt user for cycle name
            const cycleName = prompt('Enter cycle name (leave empty for default):');

            // Handle cancellation
            if (cycleName === null) {
                return;
            }

            // Call business logic to add cycle
            const newCycle = cycleManagementAdd(projectId, iterationId, cycleName);

            // If successful, re-render the workflow to show new cycle
            if (newCycle) {
                renderMainContent();
                showToast(`✅ Cycle "${newCycle.name}" added successfully`, 'success');
            }
            // If failed, cycleManagementAdd already showed alert
        }

        /**
         * T032: Handle Rename Cycle button click
         * 处理重命名循环按钮点击
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - Cycle ID to rename
         */
        function handleRenameCycle(projectId, iterationId, cycleId) {
            // Find current cycle to get existing name
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return;

            const cycle = iteration.cycles.find(c => c.id === cycleId);
            if (!cycle) return;

            // Prompt user with current name pre-filled
            const newName = prompt('Enter new cycle name:', cycle.name);

            // Handle cancellation
            if (newName === null) {
                return;
            }

            // Call business logic to rename cycle
            const success = cycleManagementRename(projectId, iterationId, cycleId, newName);

            // If successful, re-render to show updated name
            if (success) {
                renderMainContent();
                showToast(`✅ Cycle renamed to "${newName}"`, 'success');
            }
            // If failed, cycleManagementRename already showed alert
        }

        /**
         * T040: Handle Delete Cycle button click
         * 处理删除循环按钮点击
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - Cycle ID to delete
         */
        function handleDeleteCycle(projectId, iterationId, cycleId) {
            // Call business logic to delete cycle (includes confirmation)
            const success = cycleManagementDelete(projectId, iterationId, cycleId);

            // If successful, re-render to show updated cycle list
            if (success) {
                renderMainContent();
                showToast(`✅ Cycle deleted successfully`, 'success');
            }
            // If failed or cancelled, cycleManagementDelete already handled it
        }

        /**
         * T048: Handle Cycle Switch (dropdown onchange)
         * 处理循环切换（下拉框onChange）
         * @param {string} projectId - Project ID
         * @param {string} iterationId - Iteration ID
         * @param {string} cycleId - New cycle ID to switch to
         */
        function handleCycleSwitch(projectId, iterationId, cycleId) {
            // Call business logic to switch cycle
            const success = cycleManagementSwitch(projectId, iterationId, cycleId);

            // If successful, re-render to show new cycle's data
            if (success) {
                renderMainContent();
                // No toast for cycle switch - it's a frequent operation
            }
            // If failed, cycleManagementSwitch already showed alert
        }


        // 打开新建项目模态框
        function openAddProjectModal() {
            document.getElementById('addProjectModal').classList.add('active');
            document.getElementById('newProjectName').value = '';
            document.getElementById('newProjectName').focus();
        }

        // 关闭新建项目模态框
        function closeAddProjectModal() {
            document.getElementById('addProjectModal').classList.remove('active');
        }

        // 添加项目
        function addProject() {
            const name = document.getElementById('newProjectName').value.trim();
            if (!name) {
                alert('请输入项目名称');
                return;
            }

            const project = {
                id: 'project_' + Date.now(),
                name: name,
                createdAt: new Date().toISOString(),
                iterations: [{
                    id: 'iteration_' + Date.now(),
                    name: '初始开发',
                    description: '',
                    createdAt: new Date().toISOString(),
                    completedSteps: {},
                    inputs: {},
                    notes: {},
                    currentCycle: 'init',
                    cycleHistory: {}
                }]
            };

            projects.push(project);
            saveProjects();
            closeAddProjectModal();

            // 自动选中新建的项目
            selectedProjectId = project.id;
            selectedIterationId = project.iterations[0].id;
            expandedProjects.add(project.id);

            renderProjectTree();
            renderMainContent();
            showToast(`✅ 项目"${project.name}"已创建`, 'success');
        }

        // 删除项目
        async function deleteProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            const confirmed = await showConfirm({
                title: '删除项目',
                message: `确定要删除项目"${project.name}"吗？`,
                confirmText: '删除',
                cancelText: '取消',
                danger: true
            });
            if (!confirmed) {
                return;
            }

            projects = projects.filter(p => p.id !== projectId);

            // T021: Auto-save - Delete from Firebase
            if (currentUser && firebaseInitialized) {
                try {
                    await deleteProjectFromFirebase(currentUser.uid, projectId);
                } catch (error) {
                    console.error('Failed to delete from Firebase:', error);
                }
            }

            saveProjects();

            // 如果删除的是当前选中的项目，重新选择
            if (selectedProjectId === projectId) {
                if (projects.length > 0) {
                    selectedProjectId = projects[0].id;
                    selectedIterationId = projects[0].iterations[0]?.id || null;
                    expandedProjects.add(projects[0].id);
                } else {
                    selectedProjectId = null;
                    selectedIterationId = null;
                }
            }

            expandedProjects.delete(projectId);
            renderProjectTree();
            renderMainContent();
            showToast(`✅ 已删除项目"${project.name}"`, 'success');
        }

        // ============================================
        // T023-T025: NEW CRUD EVENT HANDLERS (User Story 1)
        // ============================================

        /**
         * T023: Handle edit project (inline edit)
         * 处理编辑项目（内联编辑）
         * @param {string} projectId - Project ID to edit
         */
        function handleEditProject(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) {
                showToast('Project not found', 'error');
                return;
            }

            // Prompt for new name
            const newName = prompt('Edit project name:', project.name);
            if (newName === null) return; // User cancelled

            // Prompt for new description
            const newDescription = prompt('Edit project description (optional):', project.description || '');
            if (newDescription === null) return; // User cancelled

            // Call business logic
            const result = projectCRUDEdit(projectId, newName, newDescription);

            if (!result.success) {
                showToast(`❌ ${result.error}`, 'error');
                return;
            }

            // Update UI
            renderProjectTree();
            if (selectedProjectId === projectId) {
                renderMainContent();
            }
            showToast(`✅ Project "${project.name}" updated`, 'success');
        }

        /**
         * T024: Handle duplicate project
         * 处理复制项目
         * @param {string} projectId - Project ID to duplicate
         */
        function handleDuplicateProject(projectId) {
            const result = projectCRUDDuplicate(projectId);

            if (!result.success) {
                showToast(`❌ ${result.error}`, 'error');
                return;
            }

            // Automatically select and expand the new project
            selectedProjectId = result.newProjectId;
            const newProject = projects.find(p => p.id === result.newProjectId);
            if (newProject && newProject.iterations.length > 0) {
                selectedIterationId = newProject.iterations[0].id;
            }
            expandedProjects.add(result.newProjectId);

            // Update UI
            renderProjectTree();
            renderMainContent();
            showToast(`✅ Project duplicated: "${newProject.name}"`, 'success');
        }

        /**
         * T025: Handle delete project with confirmation
         * 处理删除项目（带确认）
         * @param {string} projectId - Project ID to delete
         */
        async function handleDeleteProject(projectId) {
            const result = await projectCRUDDelete(projectId);

            if (!result.confirmed) {
                // User cancelled or project not found
                if (result.error) {
                    showToast(`❌ ${result.error}`, 'error');
                }
                return;
            }

            // Handle UI state if deleted project was currently selected
            if (selectedProjectId === projectId) {
                if (projects.length > 0) {
                    // Select first available project
                    selectedProjectId = projects[0].id;
                    selectedIterationId = projects[0].iterations[0]?.id || null;
                    expandedProjects.add(projects[0].id);
                } else {
                    // No projects left
                    selectedProjectId = null;
                    selectedIterationId = null;
                }
            }

            // Remove from expanded set
            expandedProjects.delete(projectId);

            // Update UI
            renderProjectTree();
            renderMainContent();
            showToast('✅ Project deleted successfully', 'success');
        }

        // ============================================
        // END NEW CRUD EVENT HANDLERS
        // ============================================

        /**
         * T039: Handle project click for navigation with smooth scroll
         * 处理项目点击以进行导航和平滑滚动
         * @param {string} projectId - Project ID to navigate to
         */
        function handleProjectClick(projectId) {
            // Set selected project
            selectedProjectId = projectId;
            selectedIterationId = null;

            // Expand the project if it has iterations
            const project = projects.find(p => p.id === projectId);
            if (project && project.iterations.length > 0) {
                expandedProjects.add(projectId);
                // Auto-select first iteration if available
                selectedIterationId = project.iterations[0].id;
            }

            // Update UI
            renderProjectTree();
            renderMainContent();

            // Smooth scroll to main content area
            setTimeout(() => {
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // ============================================
        // COMMAND LIBRARY EVENT HANDLERS (T062-T070)
        // ============================================

        /**
         * T062: Handle add command with prompt dialogs
         * 处理添加命令，使用提示对话框获取输入
         */
        function handleAddCommand() {
            // Prompt for label
            const label = prompt('请输入命令标签（例如："创建规格说明"）:');
            if (!label) {
                return; // User cancelled
            }

            // Prompt for text
            const text = prompt('请输入命令文本（例如："/speckit.specify [description]"）:');
            if (!text) {
                return; // User cancelled
            }

            // Prompt for optional category
            const category = prompt('请输入分类（可选，例如："Spec Kit Workflow"、"Git"）:', '');

            // Call business logic
            const result = commandLibraryAdd(label, text, category || '');

            if (result.success) {
                showToast('✅ 命令已添加', 'success');
                renderCommandLibrary(); // Re-render to show new command
            } else {
                showToast(`❌ 添加失败: ${result.error}`, 'error');
            }
        }

        /**
         * T063: Handle edit command with prompt dialogs
         * 处理编辑命令，使用提示对话框获取新值
         * @param {string} commandId - Command ID to edit
         */
        function handleEditCommand(commandId) {
            // Find the command
            const command = commands.find(c => c.id === commandId);
            if (!command) {
                showToast('❌ 命令不存在', 'error');
                return;
            }

            // Prompt for new label
            const newLabel = prompt('请输入新的命令标签:', command.label);
            if (newLabel === null) {
                return; // User cancelled
            }

            // Prompt for new text
            const newText = prompt('请输入新的命令文本:', command.text);
            if (newText === null) {
                return; // User cancelled
            }

            // Prompt for new category
            const newCategory = prompt('请输入新的分类（可选）:', command.category);
            if (newCategory === null) {
                return; // User cancelled
            }

            // Call business logic
            const result = commandLibraryEdit(commandId, newLabel, newText, newCategory);

            if (result.success) {
                showToast('✅ 命令已更新', 'success');
                renderCommandLibrary(); // Re-render to show updated command
            } else {
                showToast(`❌ 更新失败: ${result.error}`, 'error');
            }
        }

        /**
         * T064: Handle delete command with confirmation
         * 处理删除命令，带确认对话框
         * @param {string} commandId - Command ID to delete
         */
        async function handleDeleteCommand(commandId) {
            // Find the command for confirmation message
            const command = commands.find(c => c.id === commandId);
            if (!command) {
                showToast('❌ 命令不存在', 'error');
                return;
            }

            // Confirm deletion
            const confirmed = await showConfirm({
                title: '删除命令',
                message: `确定要删除命令"${command.label}"吗？此操作无法撤销。`,
                confirmText: '删除',
                cancelText: '取消',
                danger: true
            });
            if (!confirmed) {
                return;
            }

            // Call business logic
            const result = commandLibraryDelete(commandId);

            if (result.success) {
                showToast('✅ 命令已删除', 'success');
                renderCommandLibrary(); // Re-render to remove deleted command
            } else {
                showToast(`❌ 删除失败: ${result.error}`, 'error');
            }
        }

        /**
         * T065: Handle copy command to clipboard with toast notification
         * 处理复制命令到剪贴板，显示提示通知
         * @param {string} commandId - Command ID to copy
         */
        async function handleCopyCommand(commandId) {
            // Find the command
            const command = commands.find(c => c.id === commandId);
            if (!command) {
                showToast('❌ 命令不存在', 'error');
                return;
            }

            // Call business logic (async)
            const result = await commandLibraryCopy(command.text);

            if (result.success) {
                showToast('✅ 已复制到剪贴板', 'success');
            } else {
                showToast(`❌ 复制失败: ${result.error}`, 'error');
            }
        }

        /**
         * T066: Handle search/filter commands with real-time update
         * 处理命令搜索/过滤，实时更新显示
         * @param {string} searchTerm - Search term from input
         */
        function handleSearchCommands(searchTerm) {
            // Call business logic to filter commands
            const filteredCommands = commandLibrarySearch(searchTerm);

            // Re-render with filtered results
            renderCommandLibrary(filteredCommands);
        }

        /**
         * T067: Handle drag start for command reordering
         * 处理拖动开始，用于命令重新排序
         * @param {DragEvent} event - Drag event
         * @param {string} commandId - Command ID being dragged
         */
        function handleDragStart(event, commandId) {
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/plain', commandId);
            event.target.style.opacity = '0.5';
        }

        /**
         * T068: Handle drag over to allow drop
         * 处理拖动悬停，允许放置
         * @param {DragEvent} event - Drag event
         */
        function handleDragOver(event) {
            event.preventDefault(); // Allow drop
            event.dataTransfer.dropEffect = 'move';
        }

        /**
         * T069: Handle drop to reorder commands
         * 处理放置，重新排序命令
         * @param {DragEvent} event - Drop event
         * @param {string} targetCommandId - Target command ID
         */
        function handleDrop(event, targetCommandId) {
            event.preventDefault();
            const sourceCommandId = event.dataTransfer.getData('text/plain');

            // Reset opacity
            const draggedElement = document.querySelector(`[draggable="true"][ondragstart*="${sourceCommandId}"]`);
            if (draggedElement) {
                draggedElement.style.opacity = '1';
            }

            // Don't reorder if dropped on itself
            if (sourceCommandId === targetCommandId) {
                return;
            }

            // Call business logic
            const result = commandLibraryReorder(sourceCommandId, targetCommandId);

            if (result.success) {
                showToast('✅ 命令已重新排序', 'success');
                renderCommandLibrary(); // Re-render with new order
            } else {
                showToast(`❌ 排序失败: ${result.error}`, 'error');
            }
        }

        /**
         * T070: Switch between tabs (Projects and Commands)
         * 在标签页之间切换（项目和命令）
         * @param {string} tabName - Tab name: 'projects' or 'commands'
         */
        function switchTab(tabName) {
            // Update tab button states
            const tabButtons = document.querySelectorAll('.view-tab-btn');
            tabButtons.forEach(btn => {
                btn.classList.remove('active');
            });

            // Find and activate the clicked tab button
            const activeButton = Array.from(tabButtons).find(btn =>
                btn.textContent.includes(tabName === 'projects' ? '项目管理' : '命令库')
            );
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // Show/hide tab content
            const projectsTab = document.getElementById('projects-tab');
            const commandsTab = document.getElementById('commands-tab');

            if (tabName === 'projects') {
                projectsTab.style.display = 'block';
                commandsTab.style.display = 'none';
            } else if (tabName === 'commands') {
                projectsTab.style.display = 'none';
                commandsTab.style.display = 'block';
                // T030 [US1]: Render column selector before command library
                renderColumnSelector();
                // Render command library when switching to commands tab
                renderCommandLibrary();
            }
        }

        // END COMMAND LIBRARY EVENT HANDLERS
        // ============================================

        // 打开新建迭代模态框
        function openAddIterationModal(projectId) {
            currentProjectId = projectId;
            document.getElementById('addIterationModal').classList.add('active');
            document.getElementById('newIterationName').value = '';
            document.getElementById('newIterationDesc').value = '';
            document.getElementById('newIterationName').focus();
        }

        // 关闭新建迭代模态框
        function closeAddIterationModal() {
            document.getElementById('addIterationModal').classList.remove('active');
        }

        // 添加迭代
        function addIteration() {
            const name = document.getElementById('newIterationName').value.trim();
            const description = document.getElementById('newIterationDesc').value.trim();
            
            if (!name) {
                alert('请输入迭代名称');
                return;
            }
            
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;
            
            const iteration = {
                id: 'iteration_' + Date.now(),
                name: name,
                description: description,
                createdAt: new Date().toISOString(),
                completedSteps: {},
                inputs: {},
                notes: {},
                currentCycle: 'init',
                cycleHistory: {}
            };
            
            project.iterations.unshift(iteration);
            saveProjects();
            closeAddIterationModal();

            // 自动选中新建的迭代
            selectedProjectId = currentProjectId;
            selectedIterationId = iteration.id;
            expandedProjects.add(currentProjectId);

            renderProjectTree();
            renderMainContent();
            showToast(`✅ 迭代"${iteration.name}"已创建`, 'success');
        }

        // 删除迭代 (从项目概览页调用时暂不支持，可从迭代树调用)
        async function deleteIteration(projectId, iterationId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const iteration = project.iterations.find(i => i.id === iterationId);
            const confirmed = await showConfirm({
                title: '删除迭代',
                message: `确定要删除迭代"${iteration.name}"吗？`,
                confirmText: '删除',
                cancelText: '取消',
                danger: true
            });
            if (!confirmed) {
                return;
            }

            if (project.iterations.length === 1) {
                showToast('无法删除最后一个迭代', 'warning');
                return;
            }

            project.iterations = project.iterations.filter(i => i.id !== iterationId);
            saveProjects();

            // 如果删除的是当前选中的迭代，选择第一个迭代
            if (selectedIterationId === iterationId) {
                selectedIterationId = project.iterations[0]?.id || null;
            }

            renderProjectTree();
            renderMainContent();
            showToast(`✅ 已删除迭代"${iteration.name}"`, 'success');
        }

        // 保存输入内容
        function saveInput(projectId, iterationId, stepId, value) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const iteration = project.iterations.find(i => i.id === iterationId);
                if (!iteration) return;

                // T043: Sanitize input before saving
                iteration.inputs[stepId] = sanitizeInput(value);
                saveProjects();
            } catch (error) {
                // T044: Log errors
                logError(error, `saveInput(${projectId}, ${iterationId}, ${stepId})`);
                showToast('保存输入失败，请重试', 'error');
            }
        }

        // 保存笔记
        function saveNotes(projectId, iterationId, stepId, value) {
            try {
                const project = projects.find(p => p.id === projectId);
                if (!project) return;

                const iteration = project.iterations.find(i => i.id === iterationId);
                if (!iteration) return;

                // T043: Sanitize notes before saving
                iteration.notes[stepId] = sanitizeInput(value);
                saveProjects();
            } catch (error) {
                // T044: Log errors
                logError(error, `saveNotes(${projectId}, ${iterationId}, ${stepId})`);
                showToast('保存备注失败，请重试', 'error');
            }
        }

        // 选择循环颜色
        function selectCycle(projectId, iterationId, cycle) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return;

            iteration.currentCycle = cycle;
            saveProjects();

            // 重新渲染主内容区
            renderMainContent();
        }

        /**
         * T043: Input sanitization for XSS prevention
         * 清理用户输入，防止 XSS 攻击
         */
        function sanitizeInput(input) {
            if (typeof input !== 'string') return input;

            // Escape HTML special characters
            const div = document.createElement('div');
            div.textContent = input;
            return div.innerHTML;
        }

        /**
         * T044: Error logging utility
         * 错误日志记录
         */
        function logError(error, context = '') {
            const errorLog = {
                timestamp: new Date().toISOString(),
                context: context,
                message: error.message || String(error),
                stack: error.stack || '',
                userAgent: navigator.userAgent,
                currentUser: currentUser ? currentUser.uid : 'anonymous'
            };

            console.error('🔴 Error Log:', errorLog);

            // Store in localStorage for debugging (max 50 entries)
            try {
                let errorLogs = JSON.parse(localStorage.getItem('speckit_error_logs') || '[]');
                errorLogs.unshift(errorLog);
                errorLogs = errorLogs.slice(0, 50); // Keep only last 50 errors
                localStorage.setItem('speckit_error_logs', JSON.stringify(errorLogs));
            } catch (e) {
                console.error('Failed to store error log:', e);
            }

            return errorLog;
        }

        /**
         * T039: Auto-resize input fields based on content
         * T041: Limit height to 5 lines with scrollbar
         * T042: Detect code snippets and apply monospace font
         * 自动调整输入框高度
         */
        function autoResizeInput(textarea) {
            if (!textarea) return;

            // Reset height to calculate new scrollHeight
            textarea.style.height = 'auto';

            // Calculate new height based on content
            const newHeight = textarea.scrollHeight;
            const lineHeight = 20; // Approximate line height in pixels
            const maxLines = 5;
            const maxHeight = lineHeight * maxLines;

            // Apply height (T041: max 5 lines)
            if (newHeight > maxHeight) {
                textarea.style.height = `${maxHeight}px`;
                textarea.style.overflowY = 'auto';
            } else {
                textarea.style.height = `${newHeight}px`;
                textarea.style.overflowY = 'hidden';
            }

            // T042: Detect code snippets (contains /, {, }, [, ], <, > or starts with special chars)
            const value = textarea.value;
            const codePatterns = /[\/\{\}\[\]<>]|^[\$#>]|^\s{2,}/m;

            if (codePatterns.test(value) || value.length > 50) {
                textarea.classList.add('code-style');
            } else {
                textarea.classList.remove('code-style');
            }
        }

        /**
         * T039: Initialize auto-resize for all input fields
         * 为所有输入框初始化自动调整
         */
        function initAutoResizeInputs() {
            const inputs = document.querySelectorAll('.command-input');
            inputs.forEach(input => {
                autoResizeInput(input);

                // Add event listeners for dynamic resizing
                input.addEventListener('input', function() {
                    autoResizeInput(this);
                });

                input.addEventListener('paste', function() {
                    setTimeout(() => autoResizeInput(this), 10);
                });
            });
        }

        /**
         * T035: Detect when Step IX (merge) is copied
         * T036-T038: Offer to auto-complete all steps
         * 检测步骤 IX 被复制，提供一键完成所有步骤选项
         */
        function detectStepIXCopy(projectId, iterationId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return;

            // Check how many steps are NOT completed yet
            const allStepIds = commandSteps.map(s => s.id);
            const incompleteSteps = allStepIds.filter(id => !iteration.completedSteps[id]);

            // If user has already completed most steps manually, don't prompt
            if (incompleteSteps.length <= 1) {
                return; // Already done, or only Step IX itself
            }

            // Prompt user with confirmation
            setTimeout(async () => {
                const confirmed = await showConfirm({
                    title: '🎉 检测到完成 Step IX',
                    message: `是否自动标记所有前置步骤为已完成？这将标记 ${incompleteSteps.length - 1} 个未完成步骤。`,
                    confirmText: '自动完成',
                    cancelText: '取消'
                });

                if (confirmed) {
                    autoCompleteAllSteps(projectId, iterationId);
                }
            }, 500); // Delay to avoid blocking clipboard operation
        }

        /**
         * T036: Auto-complete all steps when Step IX is copied
         * T038: Idempotent - only marks incomplete steps
         * 自动完成所有步骤（幂等操作）
         */
        function autoCompleteAllSteps(projectId, iterationId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return;

            let completedCount = 0;

            // Mark all steps as completed (T038: idempotent)
            commandSteps.forEach(step => {
                if (!iteration.completedSteps[step.id]) {
                    iteration.completedSteps[step.id] = true;

                    // Record cycle color for completion
                    if (step.phase === 'init') {
                        iteration.cycleHistory[step.id] = 'init';
                    } else {
                        iteration.cycleHistory[step.id] = iteration.currentCycle;
                    }

                    completedCount++;
                }
            });

            // Save and update UI
            saveProjects();
            renderProjectTree();
            renderWorkflowArea(); // Refresh main area to show all completed badges

            // T037: Visual notification (toast)
            showToast(`✅ 批量完成：已自动标记 ${completedCount} 个步骤为已完成`, 'success');
        }

        // 复制命令并标记完成
        function copyCommandWithTracking(projectId, iterationId, stepId, hasInput) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const iteration = project.iterations.find(i => i.id === iterationId);
            if (!iteration) return;
            
            const step = commandSteps.find(s => s.id === stepId);
            let command = step.command;
            
            if (hasInput) {
                const card = document.querySelector(`[data-project="${projectId}"][data-iteration="${iterationId}"][data-step="${stepId}"]`);
                const input = card.querySelector('.command-input');
                const inputValue = input.value.trim();
                if (inputValue) {
                    command = `${step.command} ${inputValue}`;
                }
            }
            
            navigator.clipboard.writeText(command).then(() => {
                iteration.completedSteps[stepId] = true;
                
                // 记录完成时的循环颜色
                const step = commandSteps.find(s => s.id === stepId);
                if (step.phase === 'init') {
                    iteration.cycleHistory[stepId] = 'init';
                } else {
                    iteration.cycleHistory[stepId] = iteration.currentCycle;
                }

                saveProjects();
                renderProjectTree(); // T031: Real-time sidebar update when step completed

                // T035: Detect Step IX copy (smart completion)
                if (stepId === 'merge') {
                    detectStepIXCopy(projectId, iterationId);
                }

                const card = document.querySelector(`[data-project="${projectId}"][data-iteration="${iterationId}"][data-step="${stepId}"]`);
                
                // 添加对应的循环颜色类
                let cycleClass = step.phase === 'init' ? 'init-phase' : iteration.currentCycle;
                card.classList.add('completed', cycleClass);
                
                if (!card.querySelector('.completed-badge')) {
                    const badge = document.createElement('div');
                    badge.className = 'completed-badge';
                    badge.textContent = '✓ 已完成';
                    card.appendChild(badge);
                }
                
                const button = card.querySelector('.copy-btn');
                const originalText = button.textContent;
                button.textContent = '✅ 已复制！';
                button.classList.add('copied');
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);

                // 更新项目树显示进度
                renderProjectTree();
            }).catch(err => {
                showToast('复制失败，请重试', 'error');
            });
        }

        // 页面加载时初始化
        init();

        // 支持回车键
        document.getElementById('newProjectName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addProject();
        });

        document.getElementById('newIterationName').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') addIteration();
        });

        // 点击模态框外部关闭
        document.getElementById('addProjectModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddProjectModal();
        });

        document.getElementById('addIterationModal').addEventListener('click', function(e) {
            if (e.target === this) closeAddIterationModal();
        });

        document.getElementById('importModal').addEventListener('click', function(e) {
            if (e.target === this) closeImportModal();
        });

        document.getElementById('clearDataModal').addEventListener('click', function(e) {
            if (e.target === this) closeClearDataModal();
        });

        // ========================================
        // Initialize Firebase on page load
        // ========================================
        window.addEventListener('load', async () => {
            console.log('🚀 Initializing Firebase...');

            // Initial connection status display
            updateConnectionStatus();

            await initFirebase();

            // Update connection status after Firebase initialization
            updateConnectionStatus();

            // If Firebase config is not set (placeholder values), show warning
            if (firebaseConfig.apiKey === 'YOUR_API_KEY') {
                console.warn('⚠️ Firebase config not set. Please update firebaseConfig in index.html');
                console.warn('   See FIREBASE_SETUP.md for instructions');
                showToast('⚠️ Firebase 未配置，请查看 FIREBASE_SETUP.md 文档', 'warning');
            }
        });

        // Also listen for online/offline events
        window.addEventListener('online', () => {
            isOnline = true;
            window.isOnline = true; // Sync to window for testing
            console.log('🟢 Back online');
            updateConnectionStatus();
            processOfflineQueue();
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            window.isOnline = false; // Sync to window for testing
            console.log('🔴 Gone offline');
            updateConnectionStatus();
        });

        // T055 [US3]: Window resize handler for layout stability
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (currentTab === 'commands') {
                    renderCommandLibrary();
                }
            }, 300); // Debounce 300ms
        });
    </script>
</body>
</html>