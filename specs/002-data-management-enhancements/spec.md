# Spec: 数据管理增强功能

> **分支**: `002-data-management-enhancements`
> **状态**: 📝 规划中
> **创建时间**: 2025-10-15
> **类型**: 功能增强（Brownfield）
> **依赖**: 001-initial-implementation

---

## 📋 用户故事 (User Stories)

### US-7: 数据导出
**作为** 管理多个项目的开发者
**我想要** 将项目数据导出为 JSON 文件
**以便于** 备份数据、迁移到其他设备、或与团队成员分享

**验收标准**:
- [ ] 在项目概览页提供"导出数据"按钮
- [ ] 支持导出所有项目数据为单个 JSON 文件
- [ ] 支持导出单个项目数据
- [ ] 文件名包含时间戳（如 `speckit-backup-20251015.json`）
- [ ] 导出的 JSON 格式清晰可读（带缩进）
- [ ] 导出时显示成功提示

**用户价值**:
- 防止浏览器数据清除导致的数据丢失
- 可在多台设备间同步数据
- 可作为项目交付文档的一部分

### US-8: 数据导入
**作为** 换了设备的开发者
**我想要** 导入之前导出的 JSON 文件
**以便于** 恢复之前的项目数据

**验收标准**:
- [ ] 在项目概览页提供"导入数据"按钮
- [ ] 支持上传 JSON 文件
- [ ] 导入前验证 JSON 格式正确性
- [ ] 支持两种导入模式：
  - **合并模式**: 保留现有数据，添加新项目
  - **覆盖模式**: 清空现有数据，完全替换
- [ ] 导入前显示确认对话框
- [ ] 导入后刷新界面
- [ ] 格式错误时显示友好错误提示

**用户价值**:
- 快速恢复备份数据
- 迁移数据到新设备
- 导入团队成员分享的项目

### US-9: 数据清理
**作为** 长期使用的用户
**我想要** 清理和归档旧项目
**以便于** 保持界面整洁，释放存储空间

**验收标准**:
- [ ] 在项目概览页提供"清空所有数据"按钮
- [ ] 点击后显示警告对话框（红色主题）
- [ ] 需要输入确认文本（如"确认删除"）才能执行
- [ ] 清空后显示空状态引导
- [ ] 操作不可撤销的明确提示

**用户价值**:
- 快速重置面板开始新项目
- 清理测试数据
- 解决数据损坏问题

### US-10: 项目统计信息
**作为** 追踪进度的开发者
**我想要** 看到项目的统计信息
**以便于** 了解整体进度和时间分布

**验收标准**:
- [ ] 在项目概览卡片显示统计数据：
  - 总迭代数
  - 总完成步骤数 / 总步骤数
  - 完成百分比
  - 创建时间（相对时间，如"3 天前"）
- [ ] 在迭代详情页显示：
  - 已完成步骤按循环颜色分组统计
  - 每个阶段的完成进度
  - 预计剩余步骤数
- [ ] 统计数据实时更新

**用户价值**:
- 快速了解项目进度
- 识别瓶颈阶段
- 提供成就感反馈

---

## 🎯 业务需求 (Business Requirements)

### BR-4: 数据安全性
**需求**: 导入导出功能不能破坏数据完整性

**理由**:
- 用户依赖备份数据恢复工作
- 格式错误可能导致数据丢失
- 需要保持用户信任

**成功指标**:
- [ ] JSON Schema 验证
- [ ] 版本兼容性检查
- [ ] 错误处理覆盖所有边界情况

### BR-5: 用户体验流畅性
**需求**: 导入导出操作必须简单快速

**理由**:
- 用户不希望为备份花费太多时间
- 降低操作门槛提高使用率
- 减少支持请求

**成功指标**:
- [ ] 导出操作 < 1 秒完成
- [ ] 导入文件大小支持 < 10MB
- [ ] 一键完成，无需多步操作

---

## 🎨 用户体验需求

### UX-4: 数据管理区域
在项目概览页顶部添加"数据管理"工具栏：

```
[📊 项目概览]  [➕ 新建项目]  |  [💾 导出数据] [📂 导入数据] [🗑️ 清空数据]
```

### UX-5: 导入导出流程

#### 导出流程
1. 点击"导出数据"按钮
2. 弹出选择框：
   - [ ] 导出所有项目
   - [ ] 选择特定项目导出
3. 生成 JSON 文件并自动下载
4. 显示成功提示："数据已导出 ✅"

#### 导入流程
1. 点击"导入数据"按钮
2. 弹出文件选择器
3. 选择 JSON 文件
4. 显示预览信息：
   - 文件包含 X 个项目
   - 总计 Y 个迭代
5. 选择导入模式：合并 / 覆盖
6. 确认后执行导入
7. 显示成功提示："已导入 X 个项目 ✅"

### UX-6: 统计信息展示
在项目概览卡片底部添加进度条和统计信息：

```
┌─────────────────────────────────┐
│ 项目名称                [删除]   │
├─────────────────────────────────┤
│ 迭代进展（3 个迭代）             │
│ • 初始开发      9/9              │
│ • UI 增强       5/9              │
│ • 性能优化      0/9              │
├─────────────────────────────────┤
│ 📊 总进度: 14/27 (52%)          │
│ ⏱️ 创建于: 3 天前                │
└─────────────────────────────────┘
```

---

## 🚀 期望成果 (Expected Outcomes)

### 功能性成果
1. [ ] 用户可以导出所有项目为 JSON 文件
2. [ ] 用户可以导入 JSON 文件恢复数据
3. [ ] 用户可以清空所有数据重新开始
4. [ ] 用户可以看到项目的详细统计信息

### 非功能性成果
1. [ ] 导出文件格式遵循 JSON Schema 规范
2. [ ] 导入操作支持格式验证和错误提示
3. [ ] 数据管理功能符合 Constitution 简洁性原则
4. [ ] 不引入任何外部依赖（纯原生实现）

### 用户体验成果
1. [ ] 导出导入操作直观易懂
2. [ ] 统计信息提供有价值的洞察
3. [ ] 数据清理有充分的安全提示
4. [ ] 所有操作提供即时反馈

---

## 📐 技术约束

### 遵循 Constitution 约束
- ✅ **简洁性**: 使用原生 File API 和 Blob，无需外部库
- ✅ **架构完整性**: 保持单文件架构，导入导出为纯函数
- ✅ **规范术语**: 使用 Project、Iteration 等标准术语
- ✅ **模块化代码**: 新增函数不超过 50 行

### 数据格式规范

#### 导出 JSON Schema
```json
{
  "version": "1.0",
  "exportDate": "2025-10-15T10:30:00Z",
  "projects": [
    {
      "id": "project_1234567890",
      "name": "项目名称",
      "createdAt": "2025-10-10T08:00:00Z",
      "iterations": [
        {
          "id": "iteration_1234567890",
          "name": "初始开发",
          "description": "描述文本",
          "createdAt": "2025-10-10T08:00:00Z",
          "completedSteps": {
            "init-new": true,
            "constitution": true
          },
          "inputs": {
            "init-new": "my-project"
          },
          "notes": {
            "init-new": "笔记内容"
          },
          "currentCycle": "cycle-1",
          "cycleHistory": {
            "init-new": "init",
            "constitution": "cycle-1"
          }
        }
      ]
    }
  ]
}
```

#### 版本兼容性
- 支持读取 v1.0 格式
- 未来版本添加字段时保持向后兼容
- 导入时自动补全缺失字段的默认值

---

## ⚠️ 边界情况处理

### BC-1: 文件大小限制
- **问题**: 项目过多导致 JSON 文件超大
- **解决**: 限制导出项目数量，分批导出

### BC-2: 格式错误
- **问题**: 用户导入非法 JSON 或错误格式
- **解决**: 使用 try-catch 捕获，显示具体错误信息

### BC-3: ID 冲突
- **问题**: 导入数据的 ID 与现有数据冲突
- **解决**: 合并模式下自动重新生成冲突 ID

### BC-4: 数据损坏
- **问题**: LocalStorage 数据损坏无法解析
- **解决**: 提供"修复数据"功能或清空重置

---

## 🧪 测试场景

### TS-1: 导出功能测试
1. 创建 3 个项目，每个项目 2 个迭代
2. 部分步骤标记为完成
3. 点击"导出数据"
4. 验证下载的 JSON 文件：
   - [ ] 包含所有项目和迭代
   - [ ] 完成状态正确保存
   - [ ] 输入和笔记内容完整
   - [ ] 循环历史记录正确

### TS-2: 导入功能测试（合并模式）
1. 已有 2 个项目
2. 导入包含 3 个项目的 JSON 文件（合并模式）
3. 验证结果：
   - [ ] 现有 2 个项目保持不变
   - [ ] 新增 3 个项目
   - [ ] 总计 5 个项目
   - [ ] 所有数据正确显示

### TS-3: 导入功能测试（覆盖模式）
1. 已有 2 个项目
2. 导入包含 3 个项目的 JSON 文件（覆盖模式）
3. 验证结果：
   - [ ] 原有 2 个项目被清除
   - [ ] 只显示导入的 3 个项目
   - [ ] 所有数据正确显示

### TS-4: 错误处理测试
1. 尝试导入纯文本文件 → 显示"文件格式错误"
2. 尝试导入缺少必需字段的 JSON → 显示具体缺失字段
3. 尝试导入 10MB+ 的巨大文件 → 显示"文件过大"警告
4. 导入过程中刷新页面 → 不破坏现有数据

### TS-5: 统计信息测试
1. 创建项目并完成部分步骤
2. 验证概览卡片显示：
   - [ ] 正确的完成步骤数
   - [ ] 正确的百分比
   - [ ] 正确的创建时间（相对时间）
3. 标记更多步骤完成
4. 验证统计信息实时更新

---

## 📊 成功指标

| 指标 | 目标值 |
|-----|--------|
| 导出操作响应时间 | < 1 秒 |
| 导入操作响应时间 | < 2 秒（100 个项目） |
| JSON 文件大小 | < 1MB（50 个项目） |
| 格式验证准确率 | 100% |
| 错误提示友好度 | 用户可理解，不显示技术术语 |
| 统计信息计算准确率 | 100% |

---

## 🔄 与 Constitution 的一致性检查

- [x] **简洁性**: 导入导出使用原生 API，无外部库
- [x] **架构完整性**: 保持单文件架构，新增函数遵循现有模式
- [x] **整洁代码**: 函数职责单一，命名清晰
- [x] **规范术语**: 使用 Project、Iteration、Export、Import 等术语
- [x] **集成测试**: 定义了 5 个端到端测试场景

---

## 📝 实现注意事项

### 关键技术点
1. **导出实现**: 使用 `Blob` 和 `URL.createObjectURL()`
2. **导入实现**: 使用 `FileReader` API
3. **JSON 验证**: 使用 `JSON.parse()` + 自定义验证函数
4. **统计计算**: 遍历项目数据累加计数

### 代码组织
```javascript
// 新增函数列表
function exportAllProjects()      // 导出所有项目
function exportProject(projectId) // 导出单个项目
function importProjects(file, mode) // 导入项目
function validateProjectData(data) // 验证数据格式
function clearAllData()           // 清空数据
function calculateProjectStats(project) // 计算统计信息
function formatRelativeTime(date) // 格式化相对时间
```

---

## 🎯 下一步行动

1. ✅ 完成此规范文档
2. ⏭️ 执行 `/speckit.plan` 制定技术实现计划
3. ⏭️ 执行 `/speckit.tasks` 分解任务
4. ⏭️ 执行 `/speckit.implement` 开始编码

---

**此规范已准备好进入下一阶段！**
